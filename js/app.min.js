(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B={}.hasOwnProperty,C=function(a,b){function c(){this.constructor=a}for(var d in b)B.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};q={FPS:60,fpsSkip:10,test:100,levelHeight:976,levelWidth:704,levelSpeed:1e3},h=function(){function a(){this.defineEvents(),this.keys={left:!1,right:!1,up:!1,down:!1}}return a.prototype.defineEvents=function(){var a;return a=[{keys:"left",on_keydown:function(a){return a.preventDefault(),u.keys.left=!0},on_release:function(){return u.keys.left=!1}},{keys:"right",on_keydown:function(a){return a.preventDefault(),u.keys.right=!0},on_release:function(){return u.keys.right=!1}},{keys:"down",on_keydown:function(a){return a.preventDefault(),u.keys.down=!0},on_release:function(){return u.keys.down=!1}},{keys:"up",on_keydown:function(a){return a.preventDefault(),u.keys.up=!0},on_release:function(){return u.keys.up=!1}},{keys:"r",on_keydown:function(a){return a.preventDefault(),t.reset()}},{keys:"space",on_keydown:function(a){return a.preventDefault(),t.launch()}}],keypress.register_many(a)},a}(),m=requestAnimationFrame||webkitRequestAnimationFrame||mozRequestAnimationFrame||oRequestAnimationFrame||msRequestAnimationFrame||null,g=function(){function a(){this.lastFrame=Date.now(),this.statsInit()}return a.prototype.loop=function(){var b,c;return c=Date.now(),b=c-this.lastFrame,m(a.prototype.loop.bind(this)),this.lastFrame=c,t.statsBegin(),t.update(b),t.statsEnd()},a.prototype.update=function(){},a.prototype.start=function(){return this.resize(),this.loop()},a.prototype.resize=function(){var a;return a=window.innerHeight/q.levelHeight,y.setScaleX(a),y.setScaleY(a),y.draw(),document.getElementById("container").style.width=q.levelWidth*a+"px"},a.prototype.statsInit=function(){return this.fps=new Stats,document.body.appendChild(this.fps.domElement)},a.prototype.statsBegin=function(){return this.fps.begin()},a.prototype.statsEnd=function(){return this.fps.end()},a.prototype.reset=function(){return v.reset(),w.reset()},a.prototype.launch=function(){return v.launch()},a}(),b=function(){function a(){}return a.prototype.getBoundBox=function(a){return{top:a.getY(),bottom:a.getY()+a.getHeight(),left:a.getX(),right:a.getX()+a.getWidth(),x:a.getX()+a.getWidth()/2,y:a.getY()+a.getHeight()/2,width:a.getWidth(),height:a.getHeight()}},a.prototype.colliding=function(a,b){return!(a.left>b.right||a.right<b.left||a.top>b.bottom||a.bottom<b.top)},a.prototype.getSide=function(a,b){var c,d;return c=2,d={top:!1,bot:!1,left:!1,right:!1},a.bottom<=b.top+b.height/2&&a.left<b.right-c&&a.right>b.left+c?d.top=!0:a.top>=b.bottom-b.height/2&&a.left<b.right-c&&a.right>b.left+c&&(d.bot=!0),a.left>=b.right-b.width/2&&a.bottom>=b.top+c?d.left=!0:a.right<=b.left+b.width/2&&a.bottom>=b.top+c&&(d.right=!0),d},a}(),j=function(){function a(a,b){this.x=a,this.y=b,this.draw(),this.heightCouched=30,this.height=62}return a.prototype.draw=function(){return this.shape=new Kinetic.Rect({x:this.x,y:this.y,width:32,height:62,stroke:"black",strokeWidth:1}),x.add(this.shape)},a}(),c=function(a){function b(a,c){b.__super__.constructor.call(this,a,c),this.speed=.25,this.couchSpeed=.1,this.move={left:!1,right:!1},this.fallingSpeed=6,this.maxJump=1,this.numJump=1,this.jump=!1,this.jumpLaunched=!1,this.canJump=!0,this.falling=!0,this.couched=!1,this.stopCouch=!1,this.tween=null,this.lockDirection={left:!1,right:!1},this.alive=!0}return C(b,a),b.prototype.reset=function(){return this.shape.setX(200),this.shape.setY(256),this.alive=!0},b.prototype.kill=function(){return this.shape.setX(32),this.shape.setY(32),this.alive=!1},b.prototype.update=function(a){var b;return this.alive?(b=this.couched&&!this.falling?this.couchSpeed*a:this.speed*a,this.checkCollisions(),u.keys.left&&!this.lockDirection.left&&this.shape.setX(this.shape.getX()-b),u.keys.right&&!this.lockDirection.right&&this.shape.setX(this.shape.getX()+b),u.keys.down&&!this.couched?this.couch():!u.keys.down&&this.couched&&this.wake(),u.keys.up&&!this.jump&&this.canJump&&!this.couched&&this.numJump<this.maxJump&&this.startJump(),this.couched&&this.stopCouch&&this.wake(),!this.jump&&this.falling&&this.doFall(),HTML.query("#jump").textContent=this.jump,HTML.query("#jumps").textContent=this.numJump+"/"+this.maxJump,HTML.query("#falling").textContent=!this.jump&&this.falling,HTML.query("#alive").textContent=this.alive):void 0},b.prototype.doJump=function(){var a;return a=this,this.jumpLaunched=!0,this.tween=new Kinetic.Tween({node:this.shape,duration:.3,easing:Kinetic.Easings.EaseOut,y:this.shape.getY()-84,onFinish:function(){return a.stopJump()}}),this.tween.play()},b.prototype.doFall=function(){return this.shape.setY(this.shape.getY()+this.fallingSpeed)},b.prototype.couch=function(){return this.couched===!1?(this.shape.setHeight(this.heightCouched),this.shape.setY(w.shape.getY()+(this.height-this.heightCouched)),this.couched=!0):void 0},b.prototype.wake=function(){var a;return a=this.getCountCollisions(),this.shape.setHeight(this.height),this.shape.setY(w.shape.getY()-(this.height-this.heightCouched)),this.couched=!1,this.getCountCollisions()>a?(this.shape.setHeight(this.heightCouched),this.shape.setY(w.shape.getY()+(this.height-this.heightCouched)),this.couched=!0):this.stopCouch=!1},b.prototype.startJump=function(){return this.numJump++,this.canJump=!1,this.jump=!0,this.doJump()},b.prototype.stopJump=function(){return this.jump=!1,this.jumpLaunched=!1},b.prototype.cancelJump=function(){return this.stopJump(),null!==this.tween?this.tween.pause():void 0},b.prototype.stopFall=function(a){return this.jump?void 0:(this.falling=!1,this.canJump=!0,this.numJump=0,this.shape.setY(a-this.shape.getHeight()))},b.prototype.stopDirection=function(a,b){return"left"===a?(this.lockDirection.left=!0,this.shape.setX(b)):(this.lockDirection.right=!0,this.shape.setX(b-this.shape.getWidth()))},b.prototype.checkCollisions=function(){var a,b,c,d,e,f;for(c=this,this.falling=!0,this.lockDirection.left=!1,this.lockDirection.right=!1,b=this.getCollisions(),f=[],d=0,e=b.length;e>d;d++)a=b[d],a.sides.top?f.push(c.stopFall(a.cube.getY())):(a.sides.bot&&("falling"===a.cube.getName()&&c.kill(),c.cancelJump()),a.sides.left?f.push(c.stopDirection("left",a.cube.getX()+a.cube.getWidth())):a.sides.right?f.push(c.stopDirection("right",a.cube.getX())):f.push(void 0));return f},b.prototype.getCollisions=function(){var a,b,c;return c=[],b=p.getBoundBox(this.shape),a=A.find("Rect"),a.each(function(a){var d;return d=p.getBoundBox(a),p.colliding(b,d)?c.push({cube:a,sides:p.getSide(b,d)}):void 0}),a=s.find("Rect"),a.each(function(a){var d;return d=p.getBoundBox(a),p.colliding(b,d)?c.push({cube:a,sides:p.getSide(b,d)}):void 0}),c},b.prototype.getCountCollisions=function(){var a,b,c,d,e;for(b=this.getCollisions(),c=0,d=0,e=b.length;e>d;d++)a=b[d],a.sides.bot&&c++;return c},b}(j),k={SMALL:32,MEDIUM:64,LARGE:128},d=function(){function a(a,b,c,d){this.x=a,this.y=b,this.size=c,this.color=d,this.draw()}return a.prototype.draw=function(){return this.shape=new Kinetic.Rect({x:this.x,y:this.y,width:this.size,height:this.size,fill:this.color,stroke:"black",strokeWidth:1})},a}(),f=function(a){function b(a,c,d){var e,f;e=32*a+160,f=-1*y.getY(),b.__super__.constructor.call(this,e,f,c,this.getColor()),s.add(this.shape),this.shape.setName("falling"),this.shape.draw(),this.destination=880-32*d-c,this.diffY=this.destination-f,this.speed=600,this.fall()}return C(b,a),b.prototype.fall=function(){var a,b;return a=this,b=new Kinetic.Tween({node:this.shape,duration:this.diffY/this.speed,y:this.destination,onFinish:function(){return a.shape.setName(null)}}),b.play()},b.prototype.getColor=function(){var a;return a=["red","orange","yellow","green","blue","cyan","purple"],a[Math.floor(Math.random()*a.length)]},b}(d),l=function(a){function b(a,c,d){b.__super__.constructor.call(this,a,c,d,"white"),A.add(this.shape),this.shape.draw()}return C(b,a),b}(d),e=function(){function a(){this.map=[],this.resetMap(),this.updateRate=0,this.current=0,this.levelHeight=0,this.running=!1,this.waiting=!1}return a.prototype.start=function(a,b){return this.running||this.waiting?void 0:(this.updateRate=b,this.current=0,this.levelHeight+=a,this.running=!0,HTML.query("#cmr").textContent=!0,HTML.query("#cml").textContent=a,HTML.query("#cms").textContent=b)},a.prototype.reset=function(){return this.levelHeight=0,this.stop(),this.waiting=!1,this.resetMap()},a.prototype.stop=function(){return this.running=!1,HTML.query("#cmr").textContent=!1},a.prototype.wait=function(){return this.stop(),this.waiting=!0,v.update()},a.prototype.resetMap=function(){var a,b,c;for(c=[],a=b=0;11>=b;a=++b)c.push(this.map[a]=0);return c},a.prototype.sendCube=function(){var a,b,c,d,e,g;return c=this.checkCols(),a=c.big.length,d=c.mid.length,g=c.small.length,0===g?!1:(0===a?0===d?(e=k.SMALL,this.updateRate=500):e=this.randSize(2):e=this.randSize(3),b=this.randCol(e,c),new f(b,e,this.findHeight(e,b)),this.fillMap(e,b),!0)},a.prototype.randSize=function(a){var b;return b=Math.floor(100*Math.random()),2===a&&(b-=25),1===a?k.SMALL:b>75?k.LARGE:b>40&&75>=b?k.MEDIUM:k.SMALL},a.prototype.randCol=function(a,b){return a===k.LARGE?b.big[Math.floor(Math.random()*b.big.length)]:a===k.MEDIUM?b.mid[Math.floor(Math.random()*b.mid.length)]:b.small[Math.floor(Math.random()*b.small.length)]},a.prototype.fillMap=function(a,b){var c;return c=this.findHeight(a,b),a===k.LARGE?(this.map[b]=c+4,this.map[b+1]=c+4,this.map[b+2]=c+4,this.map[b+3]=c+4):a===k.MEDIUM?(this.map[b]=c+2,this.map[b+1]=c+2):this.map[b]+=1},a.prototype.findHeight=function(a,b){var c;return c=0,a===k.LARGE?(c=this.map[b],this.map[b+1]>c&&(c=this.map[b+1]),this.map[b+2]>c&&(c=this.map[b+2]),c):a===k.MEDIUM?(c=this.map[b],this.map[b+1]>c&&(c=this.map[b+1]),c):this.map[b]},a.prototype.update=function(a){return this.running&&(this.current+=a,this.current>=this.updateRate&&(this.current=0,this.sendCube()||this.wait())),HTML.query("#cmc").textContent=this.map},a.prototype.checkCols=function(){var a,b,c,d,e,f,g,h,i;for(c=[],b=[],a=[],i=this.map,e=g=0,h=i.length;h>g;e=++g)d=i[e],f=this.levelHeight-d,f>0&&c.push(e),f>1&&this.levelHeight-this.map[e+1]>1&&b.push(e),f>3&&this.levelHeight-this.map[e+1]>3&&this.levelHeight-this.map[e+2]>3&&this.levelHeight-this.map[e+3]>3&&a.push(e);return{small:c,mid:b,big:a}},a}(),i=function(){function a(){this.level=0,this.speed=q.levelSpeed,this.tween=[],this.lastHeight=0}return a.prototype.launch=function(){return this.nextLevel()},a.prototype.reset=function(){return void 0!==this.tween[0]&&this.tween[0].pause(),void 0!==this.tween[1]&&this.tween[1].pause(),y.setY(0),z.setY(0),s.destroyChildren(),y.draw(),r.reset(),this.level=0,this.speed=q.levelSpeed},a.prototype.moveStage=function(){var a,b;return b=this,a=32*this.lastHeight,this.tween[0]=new Kinetic.Tween({node:y,duration:2,y:y.getY()+a,onFinish:function(){return r.waiting=!1,b.nextLevel()}}),this.tween[0].play(),this.tween[1]=new Kinetic.Tween({node:z,duration:2,y:z.getY()-a}),this.tween[1].play()},a.prototype.update=function(){return this.level++,this.speed-=50,this.moveStage()},a.prototype.randomizeHeight=function(){return Math.floor(3*Math.random()+4)},a.prototype.nextLevel=function(){return this.clearLevel(),this.lastHeight=this.randomizeHeight(),r.start(this.lastHeight,this.speed),HTML.query("#lml").textContent=this.level},a.prototype.clearLevel=function(){var a,b;return b=32*this.lastHeight,a=s.find("Rect"),a.each(function(a){return a.getY()>-1*y.getY()+y.getHeight()?a.destroy():void 0})},a}(),a=function(){function a(){this.y=y.getHeight()-96,this.draw()}return a.prototype.draw=function(){var a,b,c,d;for(a=b=0;13>=b;a=++b)new l(32*a+128,this.y,32);for(d=[],a=c=0;80>=c;a=++c)new l(128,this.y-32*a,32),d.push(new l(544,this.y-32*a,32));return d},a.prototype.reset=function(){return this.clear(),this.draw()},a.prototype.clear=function(){var a;return a=A.find("Rect"),a.each(function(a){return a.remove()}),A.draw()},a}(),y=new Kinetic.Stage({container:"container",width:q.levelWidth,height:q.levelHeight}),s=new Kinetic.Layer,A=new Kinetic.Layer,x=new Kinetic.Layer,z=new Kinetic.Layer,y.add(z),y.add(x),y.add(A),y.add(s),o=new Kinetic.Rect({width:y.getWidth(),height:y.getHeight(),fill:"grey",stroke:"black"}),z.add(o),o.draw(),t=new g,t.start(),p=new b,n=new a,u=new h,w=new c(500,256),r=new e,v=new i,new f(0,k.MEDIUM,1),new f(3,k.SMALL,0),new f(5,k.MEDIUM,2),new f(7,k.SMALL,0),new f(7,k.SMALL,1),t.update=function(a){var b;return x.draw(),w.update(a),r.update(a),b=s.find("Rect"),HTML.query("#cc").textContent=b.length},window.onresize=function(){return t.resize()}}).call(this);