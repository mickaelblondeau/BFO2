(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F={}.hasOwnProperty,G=function(a,b){function c(){this.constructor=a}for(var d in b)F.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},H=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};u={levelHeight:976,levelWidth:704,levelSpeed:1e3,playerJumpMax:1,playerJumpHeight:80,playerSpeed:.3},i=function(){function a(){this.defineEvents(),this.keys={left:!1,right:!1,up:!1,down:!1}}return a.prototype.defineEvents=function(){var a;return a=[{keys:"left",on_keydown:function(a){return a.preventDefault(),x.keys.left=!0},on_release:function(){return x.keys.left=!1}},{keys:"right",on_keydown:function(a){return a.preventDefault(),x.keys.right=!0},on_release:function(){return x.keys.right=!1}},{keys:"down",on_keydown:function(a){return a.preventDefault(),x.keys.down=!0},on_release:function(){return x.keys.down=!1}},{keys:"up",on_keydown:function(a){return a.preventDefault(),x.keys.up=!0},on_release:function(){return x.keys.up=!1}},{keys:"r",on_keydown:function(a){return a.preventDefault(),w.reset()}},{keys:"space",on_keydown:function(a){return a.preventDefault(),w.launch()}}],keypress.register_many(a)},a}(),p=requestAnimationFrame||webkitRequestAnimationFrame||mozRequestAnimationFrame||oRequestAnimationFrame||msRequestAnimationFrame||null,h=function(){function a(){this.lastFrame=Date.now(),this.statsInit()}return a.prototype.loop=function(){var b,c;return c=Date.now(),b=c-this.lastFrame,p(a.prototype.loop.bind(this)),this.lastFrame=c,w.statsBegin(),w.update(b),w.statsEnd()},a.prototype.update=function(){},a.prototype.start=function(){return this.resize(),this.loop()},a.prototype.resize=function(){var a;return a=window.innerHeight/u.levelHeight,C.setScaleX(a),C.setScaleY(a),C.draw(),document.getElementById("container").style.width=u.levelWidth*a+"px"},a.prototype.statsInit=function(){return this.fps=new Stats,document.body.appendChild(this.fps.domElement)},a.prototype.statsBegin=function(){return this.fps.begin()},a.prototype.statsEnd=function(){return this.fps.end()},a.prototype.reset=function(){return z.sendReset()},a.prototype.launch=function(){return z.sendLaunch()},a}(),d=function(){function a(){}return a.prototype.getBoundBox=function(a){return{top:a.getY(),bottom:a.getY()+a.getHeight(),left:a.getX(),right:a.getX()+a.getWidth()}},a.prototype.colliding=function(a,b){return!(a.left>=b.right||a.right<=b.left||a.top>=b.bottom||a.bottom<=b.top)},a}(),l=function(){function a(){this.heightCouched=30,this.height=62,this.draw(),this.spawn()}return a.prototype.draw=function(){return this.shape=new Kinetic.Rect({width:32,height:this.height,stroke:null}),B.add(this.shape),this.skin=new Kinetic.Shape({drawFunc:function(a){return a.beginPath(),a.arc(16,10,10,0,180,!1),a.moveTo(0,62),a.lineTo(32,62),a.lineTo(16,22),a.closePath(),a.fillStrokeShape(this)},fill:"red",stroke:"black"}),B.add(this.skin)},a.prototype.spawn=function(){return this.shape.setX(336),this.shape.setY(-1*C.getY())},a.prototype.reset=function(){return this.spawn(),this.alive=!0,this.falling=!0,this.jumpMax=u.jumpMax,this.speed=u.playerJumpMax,this.jumpHeight=u.playerJumpHeight},a.prototype.kill=function(){return this.shape.setX(32),this.shape.setY(32),this.skin.setX(32),this.skin.setY(32),this.alive=!1},a}(),e=function(a){function b(){b.__super__.constructor.call(this),this.speed=u.playerSpeed,this.couchedSpeedRatio=.5,this.fallMinAcceleration=.2,this.fallMaxAcceleration=.6,this.fallAcceleration=1.05,this.fallCurrentAcceleration=this.fallMinAcceleration,this.jumpMinAcceleration=.1,this.jumpMaxAcceleration=.6,this.jumpDeceleration=.95,this.jumpCurrentAcceleration=0,this.jumpHeight=u.playerJumpHeight,this.jumpMax=u.playerJumpMax,this.jump=!1,this.canJump=!0,this.jumpStart=0,this.jumpCount=0,this.couched=!1,this.falling=!0,this.alive=!0,this.actualCollisions=[]}return G(b,a),b.prototype.update=function(a){var b,c;return this.alive?(b=this.testDiff(),b&&"falling"===b.getName()&&(this.kill(),z.sendDie()),this.jump||this.falling||x.keys.left||x.keys.right||x.keys.up||x.keys.down?(this.jump?this.doJump(a):this.doFall(a),c=this.couched&&!this.jump?this.speed*a*this.couchedSpeedRatio:this.speed*a,x.keys.left&&(b=this.testMove(this.shape.getX()-c,0),b&&this.shape.setX(b.getX()+b.getWidth())),x.keys.right&&(b=this.testMove(this.shape.getX()+c,0),b&&this.shape.setX(b.getX()-this.shape.getWidth())),x.keys.up?this.canJump&&this.startJump():this.canJump=!0,x.keys.down?this.startCouch():this.stopCouch(),z.sendMove(this.shape.getX(),this.shape.getY()),this.skin.setX(this.shape.getX()),this.skin.setY(this.shape.getY()),this.skin.setWidth(this.shape.getWidth()),this.skin.setHeight(this.shape.getHeight())):this.couched?(this.stopCouch(),this.skin.setX(this.shape.getX()),this.skin.setY(this.shape.getY()),this.skin.setWidth(this.shape.getWidth()),this.skin.setHeight(this.shape.getHeight())):x.keys.up||(this.canJump=!0),HTML.query("#jump").textContent=this.jump,HTML.query("#jumps").textContent=this.jumpCount+"/"+this.jumpMax,HTML.query("#falling").textContent=this.falling,HTML.query("#alive").textContent=this.alive,HTML.query("#ppc").textContent=!(this.jump||this.falling||x.keys.left||x.keys.right||x.keys.up||x.keys.down)):void 0},b.prototype.doFall=function(a){var b,c;return 0===this.jumpCount&&(this.jumpCount=1),b=this.testMove(0,this.shape.getY()+this.fallCurrentAcceleration*a),c=this.fallCurrentAcceleration*this.fallAcceleration,this.fallCurrentAcceleration=c<=this.fallMaxAcceleration?c:this.fallMaxAcceleration,b?this.stopFall(b.getY()):this.falling=!0},b.prototype.stopFall=function(a){return this.shape.setY(a-this.shape.getHeight()),this.jumpCount=0,this.fallCurrentAcceleration=this.fallMinAcceleration,this.falling=!1},b.prototype.startJump=function(){return this.canJump=!1,this.jumpCount<this.jumpMax&&!this.couched?(this.jumpCount++,this.jump=!0,this.jumpCurrentAcceleration=this.jumpMaxAcceleration,this.jumpStart=this.shape.getY()):void 0},b.prototype.doJump=function(a){var b,c;return this.jumpStart-this.shape.getY()<this.jumpHeight?(b=this.testMove(0,this.shape.getY()-this.jumpCurrentAcceleration*a),c=this.jumpCurrentAcceleration*this.jumpDeceleration,this.jumpCurrentAcceleration=c>=this.jumpMinAcceleration?c:this.jumpMinAcceleration,b&&(this.shape.setY(b.getY()+b.getHeight()),this.stopJump()),this.jumpTime+=a):this.stopJump()},b.prototype.stopJump=function(){return this.jump=!1,this.falling=!0},b.prototype.startCouch=function(){return this.couched?void 0:(this.couched=!0,this.shape.setHeight(this.heightCouched),this.shape.setY(this.shape.getY()+this.height-this.heightCouched))},b.prototype.stopCouch=function(){var a;return this.couched&&(this.couched=!1,this.shape.setHeight(this.height),a=this.testMove(0,this.shape.getY()-this.height+this.heightCouched))?this.startCouch():void 0},b.prototype.getCollisions=function(){var a,b,c;return c=[],b=t.getBoundBox(this.shape),a=E.find("Rect"),a.each(function(a){var d;return d=t.getBoundBox(a),t.colliding(b,d)?c.push(a):void 0}),a=v.find("Rect"),a.each(function(a){var d;return d=t.getBoundBox(a),t.colliding(b,d)?c.push(a):void 0}),c},b.prototype.testMove=function(a,b){var c,d,e,f,g;for(e=this.getCollisions(),0!==a&&this.shape.setX(a),0!==b&&this.shape.setY(b),d=this.getCollisions(),f=0,g=d.length;g>f;f++)if(c=d[f],H.call(e,c)<0){if(0!==a&&c.getY()!==this.shape.getY()+this.shape.getHeight())return void 0!==c.getName()&&"bonus"===c.getName().split(" ")[0]?(this.takeBonus(c),!1):c;if(0!==b&&c.getX()!==this.shape.getX()+this.shape.getWidth()&&c.getX()+c.getWidth()!==this.shape.getX())return void 0!==c.getName()&&"bonus"===c.getName().split(" ")[0]?(this.takeBonus(c),!1):c}return!1},b.prototype.testDiff=function(){var a,b,c,d;for(b=this.getCollisions(),c=0,d=b.length;d>c;c++)if(a=b[c],H.call(this.actualCollisions,a)<0)return this.actualCollisions=b,a;return this.actualCollisions=b,!1},b.prototype.takeBonus=function(a){return s.getBonus(a.getName().split(" ")[1],this),a.destroy(),v.draw()},b}(l),o=function(a){function b(a){b.__super__.constructor.call(this),this.skin.setFill("white"),this.name=new Kinetic.Text({text:a,fill:"black",fontFamily:"Calibri",fontSize:18}),B.add(this.name)}return G(b,a),b.prototype.move=function(a,b){return this.shape.setX(a),this.shape.setY(b),this.skin.setX(a),this.skin.setY(b),this.name.setX(a),this.name.setY(b-20)},b.prototype.remove=function(){return this.shape.destroy(),this.skin.destroy(),this.name.destroy(),delete this},b}(l),m={BONUS:{x:0,y:0},SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},f=function(){function a(a,b,c,d){this.x=a,this.y=b,this.size=c,this.color=d,this.draw()}return a.prototype.draw=function(){return this.shape=new Kinetic.Rect({x:this.x,y:this.y,width:this.size.x,height:this.size.y,fill:this.color,stroke:"black",strokeWidth:1})},a}(),g=function(a){function b(a,c,d){var e,f;e=32*a+160,f=-1*C.getY(),b.__super__.constructor.call(this,e,f,c,this.getColor()),v.add(this.shape),this.shape.setName("falling"),this.shape.draw(),this.destination=q.y-32*d-c.y,this.diffY=this.destination-f,this.speed=600,this.fall()}return G(b,a),b.prototype.fall=function(){var a,b;return a=this,b=new Kinetic.Tween({node:this.shape,duration:this.diffY/this.speed,y:this.destination,onFinish:function(){return a.shape.setName(null)}}),b.play()},b.prototype.getColor=function(){var a;return a=["red","orange","yellow","green","blue","cyan","purple"],a[Math.floor(Math.random()*a.length)]},b}(f),n=function(a){function b(a,c,d){b.__super__.constructor.call(this,a,c,d,"white"),E.add(this.shape),this.shape.draw()}return G(b,a),b}(f),b=function(){function a(a,b,c){this.type=c,this.x=32*a+160,this.y=-1*C.getY(),this.draw(),this.destination=q.y-32*b-32,this.diffY=this.destination-this.y,this.speed=600,this.fall()}return a.prototype.fall=function(){var a;return a=new Kinetic.Tween({node:this.shape,duration:this.diffY/this.speed,y:this.destination}),a.play()},a.prototype.draw=function(){return this.shape=new Kinetic.Rect({x:this.x,y:this.y,width:32,height:32,fill:"gold",stroke:"black",strokeWidth:1,name:"bonus "+this.type}),v.add(this.shape)},a}(),c=function(){function a(){this.bonuses=[{name:"doubleJump",attribute:"jumpCount",value:1,time:3e3}]}return a.prototype.getBonus=function(a,b){var c,d,e,f,g,h;for(g=this.bonuses,h=[],e=0,f=g.length;f>e;e++)c=g[e],a===c.name?(this.addBonus(c,b),void 0!==c.time?(d=this,h.push(setTimeout(function(){return d.removeBonus(c,b)},c.time))):h.push(void 0)):h.push(void 0);return h},a.prototype.addBonus=function(a,b){switch(a.attribute){case"speed":return b.speed+=a.value;case"jumpHeight":return b.jumpHeight+=a.value;case"jumpCount":return b.jumpMax+=a.value}},a.prototype.removeBonus=function(a,b){switch(a.attribute){case"speed":return b.speed-=a.value;case"jumpHeight":return b.jumpHeight-=a.value;case"jumpCount":return b.jumpMax-=a.value}},a}(),j=function(){function a(){this.tweens=[],this.level=0}return a.prototype.reset=function(){var a,b,c,d;for(d=this.tweens,b=0,c=d.length;c>b;b++)a=d[b],void 0!==a&&a.pause();return C.setY(0),D.setY(0),q.reset(),v.destroyChildren(),C.draw(),this.level=0},a.prototype.moveLevel=function(a){return q.add(a/32),this.tweens[0]=new Kinetic.Tween({node:C,duration:2,y:C.getY()+a,onFinish:function(){return z.sendMoveLevelOk()}}),this.tweens[0].play(),this.tweens[1]=new Kinetic.Tween({node:D,duration:2,y:D.getY()-a}),this.tweens[1].play()},a.prototype.clearLevel=function(){var a;return this.level++,HTML.query("#lml").textContent=this.level,q.clearOutOfScreen(),a=v.find("Rect"),a.each(function(a){return a.getY()>-1*C.getY()+C.getHeight()?a.destroy():void 0})},a}(),k=function(){function a(){this.socket=io.connect("http://localhost:8080"),this.players=[],this.listener()}return a.prototype.listener=function(){var a;return a=this,this.socket.on("fallingCube",function(a){return new g(a[0],a[1],a[2])}),this.socket.on("resetLevel",function(){return y.reset(),A.reset()}),this.socket.on("clearLevel",function(){return y.clearLevel()}),this.socket.on("moveLevel",function(a){return y.moveLevel(a)}),this.socket.on("connection",function(b){return a.players[b[0]]=new o(b[1])}),this.socket.on("disconnect",function(b){return a.players[b].remove()}),this.socket.on("move",function(b){return void 0!==a.players[b[0]]?a.players[b[0]].move(b[1],b[2]):void 0}),this.socket.on("kill",function(b){return a.players[b].kill()})},a.prototype.sendLaunch=function(){return this.socket.emit("launch")},a.prototype.sendReset=function(){return this.socket.emit("reset")},a.prototype.sendMove=function(a,b){return this.socket.emit("move",[parseInt(a),parseInt(b)])},a.prototype.sendDie=function(){return this.socket.emit("die")},a.prototype.sendMoveLevelOk=function(){return this.socket.emit("moveLevelOk")},a}(),a=function(){function a(){this.y=C.getHeight(),this.initHeight=31,this.height=this.initHeight,this.draw()}return a.prototype.draw=function(){var a,b,c,d,e;for(a=b=0;13>=b;a=++b)new n(32*a+128,this.y,m.SMALL);for(e=[],a=c=0,d=this.height;d>=0?d>=c:c>=d;a=d>=0?++c:--c)new n(128,this.y-32*a,m.SMALL),e.push(new n(544,this.y-32*a,m.SMALL));return e},a.prototype.reset=function(){return this.height=this.initHeight,this.clear(),this.draw()},a.prototype.clear=function(){var a;return a=E.find("Rect"),a.each(function(a){return a.remove()}),E.draw()},a.prototype.add=function(a){var b,c,d,e;for(b=c=d=this.height,e=this.height+a;e>=d?e>=c:c>=e;b=e>=d?++c:--c)new n(128,this.y-32*b,m.SMALL),new n(544,this.y-32*b,m.SMALL);return this.height+=a},a.prototype.clearOutOfScreen=function(){var a;return a=E.find("Rect"),a.each(function(a){return a.getY()>-1*C.getY()+C.getHeight()?a.destroy():void 0})},a}(),C=new Kinetic.Stage({container:"container",width:u.levelWidth,height:u.levelHeight}),v=new Kinetic.Layer,B=new Kinetic.Layer,E=new Kinetic.Layer,D=new Kinetic.Layer,C.add(D),C.add(E),C.add(B),C.add(v),r=new Kinetic.Rect({width:C.getWidth(),height:C.getHeight(),fill:"grey",stroke:"black"}),D.add(r),r.setZIndex(-1),r.draw(),z=new k,w=new h,w.start(),t=new d,q=new a,x=new i,A=new e,y=new j,s=new c,new b(0,0,"doubleJump"),w.update=function(a){var b;return B.draw(),A.update(a),b=v.find("Rect"),HTML.query("#cc").textContent=b.length,b=E.find("Rect"),HTML.query("#sc").textContent=b.length},window.onresize=function(){return w.resize()}}).call(this);