(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B={}.hasOwnProperty,C=function(a,b){function c(){this.constructor=a}for(var d in b)B.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},D=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};q={FPS:60,fpsSkip:10,levelHeight:976,levelWidth:704,levelSpeed:1e3},h=function(){function a(){this.defineEvents(),this.keys={left:!1,right:!1,up:!1,down:!1}}return a.prototype.defineEvents=function(){var a;return a=[{keys:"left",on_keydown:function(a){return a.preventDefault(),u.keys.left=!0},on_release:function(){return u.keys.left=!1}},{keys:"right",on_keydown:function(a){return a.preventDefault(),u.keys.right=!0},on_release:function(){return u.keys.right=!1}},{keys:"down",on_keydown:function(a){return a.preventDefault(),u.keys.down=!0},on_release:function(){return u.keys.down=!1}},{keys:"up",on_keydown:function(a){return a.preventDefault(),u.keys.up=!0},on_release:function(){return u.keys.up=!1}},{keys:"r",on_keydown:function(a){return a.preventDefault(),t.reset()}},{keys:"space",on_keydown:function(a){return a.preventDefault(),t.launch()}}],keypress.register_many(a)},a}(),m=requestAnimationFrame||webkitRequestAnimationFrame||mozRequestAnimationFrame||oRequestAnimationFrame||msRequestAnimationFrame||null,g=function(){function a(){this.lastFrame=Date.now(),this.statsInit()}return a.prototype.loop=function(){var b,c;return c=Date.now(),b=c-this.lastFrame,m(a.prototype.loop.bind(this)),this.lastFrame=c,t.statsBegin(),t.update(b),t.statsEnd()},a.prototype.update=function(){},a.prototype.start=function(){return this.resize(),this.loop()},a.prototype.resize=function(){var a;return a=window.innerHeight/q.levelHeight,y.setScaleX(a),y.setScaleY(a),y.draw(),document.getElementById("container").style.width=q.levelWidth*a+"px"},a.prototype.statsInit=function(){return this.fps=new Stats,document.body.appendChild(this.fps.domElement)},a.prototype.statsBegin=function(){return this.fps.begin()},a.prototype.statsEnd=function(){return this.fps.end()},a.prototype.reset=function(){return v.reset(),w.reset()},a.prototype.launch=function(){return v.launch()},a}(),b=function(){function a(){}return a.prototype.getBoundBox=function(a){return{top:a.getY(),bottom:a.getY()+a.getHeight(),left:a.getX(),right:a.getX()+a.getWidth()}},a.prototype.colliding=function(a,b){return!(a.left>=b.right||a.right<=b.left||a.top>=b.bottom||a.bottom<=b.top)},a}(),j=function(){function a(){this.heightCouched=30,this.height=62,this.draw(),this.spawn()}return a.prototype.draw=function(){return this.shape=new Kinetic.Rect({width:32,height:this.height,stroke:"black",strokeWidth:1}),x.add(this.shape)},a.prototype.spawn=function(){return this.shape.setX(336),this.shape.setY(-1*y.getY())},a.prototype.reset=function(){return this.spawn(),this.alive=!0,this.falling=!0},a.prototype.kill=function(){return this.shape.setX(32),this.shape.setY(32),this.alive=!1},a}(),c=function(a){function b(a,c){b.__super__.constructor.call(this,a,c),this.speed=.3,this.couchedSpeedRatio=.5,this.fallMinAcceleration=.2,this.fallMaxAcceleration=.6,this.fallAcceleration=1.05,this.fallCurrentAcceleration=this.fallMinAcceleration,this.jumpMinAcceleration=.1,this.jumpMaxAcceleration=.6,this.jumpDeceleration=.95,this.jumpCurrentAcceleration=0,this.jumpHeight=80,this.jumpMax=1,this.jump=!1,this.canJump=!0,this.jumpStart=0,this.jumpCount=0,this.couched=!1,this.falling=!0,this.alive=!0,this.actualCollisions=[]}return C(b,a),b.prototype.update=function(a){var b,c;return this.alive?(b=this.testDiff(),b&&"falling"===b.getName()&&this.kill(),this.jump||this.falling||u.keys.left||u.keys.right||u.keys.up||u.keys.down?(this.jump?this.doJump(a):this.doFall(a),c=this.couched&&!this.jump?this.speed*a*this.couchedSpeedRatio:this.speed*a,u.keys.left&&(b=this.testMove(this.shape.getX()-c,0),b&&this.shape.setX(b.getX()+b.getWidth())),u.keys.right&&(b=this.testMove(this.shape.getX()+c,0),b&&this.shape.setX(b.getX()-this.shape.getWidth())),u.keys.up?this.canJump&&this.startJump():this.canJump=!0,u.keys.down?this.startCouch():this.stopCouch()):this.couched?this.stopCouch():u.keys.up||(this.canJump=!0),HTML.query("#jump").textContent=this.jump,HTML.query("#jumps").textContent=this.jumpCount+"/"+this.jumpMax,HTML.query("#falling").textContent=this.falling,HTML.query("#alive").textContent=this.alive,HTML.query("#ppc").textContent=!(this.jump||this.falling||u.keys.left||u.keys.right||u.keys.up||u.keys.down)):void 0},b.prototype.doFall=function(a){var b,c;return 0===this.jumpCount&&(this.jumpCount=1),b=this.testMove(0,this.shape.getY()+this.fallCurrentAcceleration*a),c=this.fallCurrentAcceleration*this.fallAcceleration,this.fallCurrentAcceleration=c<=this.fallMaxAcceleration?c:this.fallMaxAcceleration,b?this.stopFall(b.getY()):this.falling=!0},b.prototype.stopFall=function(a){return this.shape.setY(a-this.shape.getHeight()),this.jumpCount=0,this.fallCurrentAcceleration=this.fallMinAcceleration,this.falling=!1},b.prototype.startJump=function(){return this.canJump=!1,this.jumpCount<this.jumpMax&&!this.couched?(this.jumpCount++,this.jump=!0,this.jumpCurrentAcceleration=this.jumpMaxAcceleration,this.jumpStart=this.shape.getY()):void 0},b.prototype.doJump=function(a){var b,c;return this.jumpStart-this.shape.getY()<this.jumpHeight?(b=this.testMove(0,this.shape.getY()-this.jumpCurrentAcceleration*a),c=this.jumpCurrentAcceleration*this.jumpDeceleration,this.jumpCurrentAcceleration=c>=this.jumpMinAcceleration?c:this.jumpMinAcceleration,b&&(this.shape.setY(b.getY()+b.getHeight()),this.stopJump()),this.jumpTime+=a):this.stopJump()},b.prototype.stopJump=function(){return this.jump=!1,this.falling=!0},b.prototype.startCouch=function(){return this.couched?void 0:(this.couched=!0,this.shape.setHeight(this.heightCouched),this.shape.setY(this.shape.getY()+this.height-this.heightCouched))},b.prototype.stopCouch=function(){var a;return this.couched&&(this.couched=!1,this.shape.setHeight(this.height),a=this.testMove(0,this.shape.getY()-this.height+this.heightCouched))?this.startCouch():void 0},b.prototype.getCollisions=function(){var a,b,c;return c=[],b=p.getBoundBox(this.shape),a=A.find("Rect"),a.each(function(a){var d;return d=p.getBoundBox(a),p.colliding(b,d)?c.push(a):void 0}),a=s.find("Rect"),a.each(function(a){var d;return d=p.getBoundBox(a),p.colliding(b,d)?c.push(a):void 0}),c},b.prototype.testMove=function(a,b){var c,d,e,f,g;for(e=this.getCollisions(),0!==a&&this.shape.setX(a),0!==b&&this.shape.setY(b),d=this.getCollisions(),f=0,g=d.length;g>f;f++)if(c=d[f],D.call(e,c)<0){if(0!==a&&c.getY()!==this.shape.getY()+this.shape.getHeight())return c;if(0!==b&&c.getX()!==this.shape.getX()+this.shape.getWidth()&&c.getX()+c.getWidth()!==this.shape.getX())return c}return!1},b.prototype.testDiff=function(){var a,b,c,d;for(b=this.getCollisions(),c=0,d=b.length;d>c;c++)if(a=b[c],D.call(this.actualCollisions,a)<0)return this.actualCollisions=b,a;return this.actualCollisions=b,!1},b}(j),k={SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},d=function(){function a(a,b,c,d){this.x=a,this.y=b,this.size=c,this.color=d,this.draw()}return a.prototype.draw=function(){return this.shape=new Kinetic.Rect({x:this.x,y:this.y,width:this.size.x,height:this.size.y,fill:this.color,stroke:"black",strokeWidth:1})},a}(),f=function(a){function b(a,c,d){var e,f;e=32*a+160,f=-1*s.getY(),b.__super__.constructor.call(this,e,f,c,this.getColor()),s.add(this.shape),this.shape.setName("falling"),this.shape.draw(),this.destination=n.y-32*d-c.y,this.diffY=this.destination-f,this.speed=600,this.fall()}return C(b,a),b.prototype.fall=function(){var a,b;return a=this,b=new Kinetic.Tween({node:this.shape,duration:this.diffY/this.speed,y:this.destination,onFinish:function(){return a.shape.setName(null)}}),b.play()},b.prototype.getColor=function(){var a;return a=["red","orange","yellow","green","blue","cyan","purple"],a[Math.floor(Math.random()*a.length)]},b}(d),l=function(a){function b(a,c,d){b.__super__.constructor.call(this,a,c,d,"white"),A.add(this.shape),this.shape.draw()}return C(b,a),b}(d),e=function(){function a(){this.map=[],this.resetMap(),this.updateRate=0,this.current=0,this.levelHeight=0,this.running=!1,this.waiting=!1,this.types=[{proba:8,size:k.LARGE,width:k.LARGE.x/32,height:k.LARGE.y/32},{proba:26,size:k.MEDIUM,width:k.MEDIUM.x/32,height:k.MEDIUM.y/32},{proba:26,size:k.SMALL,width:k.SMALL.x/32,height:k.SMALL.y/32},{proba:16,size:k.MEDIUM_RECT,width:k.MEDIUM_RECT.x/32,height:k.MEDIUM_RECT.y/32},{proba:8,size:k.LARGE_RECT,width:k.LARGE_RECT.x/32,height:k.LARGE_RECT.y/32},{proba:16,size:k.LONG_RECT,width:k.LONG_RECT.x/32,height:k.LONG_RECT.y/32}]}return a.prototype.start=function(a,b){return this.running||this.waiting?void 0:(this.updateRate=b,this.current=0,this.levelHeight+=a,this.running=!0,HTML.query("#cmr").textContent=!0,HTML.query("#cml").textContent=a,HTML.query("#cms").textContent=b)},a.prototype.reset=function(){return this.levelHeight=0,this.stop(),this.waiting=!1,this.resetMap()},a.prototype.stop=function(){return this.running=!1,HTML.query("#cmr").textContent=!1},a.prototype.wait=function(){return this.stop(),this.waiting=!0,v.update()},a.prototype.resetMap=function(){var a,b,c;for(c=[],a=b=0;11>=b;a=++b)c.push(this.map[a]=0);return c},a.prototype.sendCube=function(){var a,b,c,d,e,g,h,i,j,k;if(b=this.checkCols(),b.length>0){for(g=this.randomizeType(b),h=g.type,i=g.index,d=b[i].length,e=Math.floor(Math.random()*d),a=b[i][e],new f(a.column,h.size,a.height),c=j=1,k=h.width;k>=1?k>=j:j>=k;c=k>=1?++j:--j)this.map[a.column+c-1]=a.height+h.height;return!0}return!1},a.prototype.randomizeType=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(e=[],t=this.types,k=l=0,p=t.length;p>l;k=++l)j=t[k],void 0!==a[k]&&a[k].length>0&&e.push({type:j,index:k,proba:j.proba});if(e.length!==this.types.length)for(i=this.types.length/e.length,m=0,q=e.length;q>m;m++)d=e[m],d.proba*=i;for(h=[],g=0,b=n=0,r=e.length;r>n;b=++n)d=e[b],g+=d.proba,h.push({index:b,percent:g});for(f=Math.floor(100*Math.random())+1,o=0,s=h.length;s>o;o++)if(c=h[o],f<=c.percent)return e[c.index];return e[h.length-1]},a.prototype.update=function(a){return this.running&&(this.current+=a,this.current>=this.updateRate&&(this.current=0,this.sendCube()||this.wait())),HTML.query("#cmc").textContent=this.map},a.prototype.checkCols=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(a=[],o=this.map,c=j=0,m=o.length;m>j;c=++j)for(b=o[c],p=this.types,i=k=0,n=p.length;n>k;i=++k){for(h=p[i],f=!0,e=0,d=l=1,q=h.width;q>=1?q>=l:l>=q;d=q>=1?++l:--l){if(g=this.map[c+d-1],!(g+h.height<=this.levelHeight)){f=!1;break}g>e&&(e=g)}f&&(void 0===a[i]&&(a[i]=[]),a[i].push({column:c,height:e}))}return a},a}(),i=function(){function a(){this.level=0,this.speed=q.levelSpeed,this.tweens=[],this.lastHeight=0}return a.prototype.launch=function(){return this.nextLevel()},a.prototype.reset=function(){var a,b,c,d;for(d=this.tweens,b=0,c=d.length;c>b;b++)a=d[b],void 0!==a&&a.pause();return y.setY(0),z.setY(0),s.destroyChildren(),y.draw(),r.reset(),this.level=0,this.speed=q.levelSpeed},a.prototype.moveStage=function(){var a,b;return b=this,a=32*this.lastHeight,this.tweens[0]=new Kinetic.Tween({node:y,duration:2,y:y.getY()+a,onFinish:function(){return r.waiting=!1,b.nextLevel()}}),this.tweens[0].play(),this.tweens[1]=new Kinetic.Tween({node:z,duration:2,y:z.getY()-a}),this.tweens[1].play()},a.prototype.update=function(){return this.level++,this.speed-=50,this.moveStage()},a.prototype.randomizeHeight=function(){return Math.floor(3*Math.random()+4)},a.prototype.nextLevel=function(){return this.clearLevel(),this.lastHeight=this.randomizeHeight(),r.start(this.lastHeight,this.speed),HTML.query("#lml").textContent=this.level},a.prototype.clearLevel=function(){var a;return a=s.find("Rect"),a.each(function(a){return a.getY()>-1*y.getY()+y.getHeight()?a.destroy():void 0})},a}(),a=function(){function a(){this.y=y.getHeight(),this.draw()}return a.prototype.draw=function(){var a,b,c,d;for(a=b=0;13>=b;a=++b)new l(32*a+128,this.y,k.SMALL);for(d=[],a=c=0;32>=c;a=++c)new l(128,this.y-32*a,k.SMALL),d.push(new l(544,this.y-32*a,k.SMALL));return d},a.prototype.reset=function(){return this.clear(),this.draw()},a.prototype.clear=function(){var a;return a=A.find("Rect"),a.each(function(a){return a.remove()}),A.draw()},a}(),y=new Kinetic.Stage({container:"container",width:q.levelWidth,height:q.levelHeight}),s=new Kinetic.Layer,x=new Kinetic.Layer,A=new Kinetic.Layer,z=new Kinetic.Layer,y.add(z),y.add(A),y.add(x),y.add(s),o=new Kinetic.Rect({width:y.getWidth(),height:y.getHeight(),fill:"grey",stroke:"black"}),z.add(o),o.setZIndex(-1),o.draw(),t=new g,t.start(),p=new b,n=new a,u=new h,w=new c,r=new e,v=new i,t.update=function(a){var b;return x.draw(),w.update(a),r.update(a),b=s.find("Rect"),HTML.query("#cc").textContent=b.length},window.onresize=function(){return t.resize()}}).call(this);