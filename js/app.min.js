(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P={}.hasOwnProperty,Q=function(a,b){function c(){this.constructor=a}for(var d in b)P.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},R=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};B={levelHeight:976,levelWidth:704,levelSpeed:1e3,playerJumpMax:1,playerJumpHeight:80,playerSpeed:.3},n=function(){function a(){this.defineEvents(),this.keys={left:!1,right:!1,up:!1,down:!1}}return a.prototype.defineEvents=function(){var a;return a=[{keys:"left",on_keydown:function(a){return a.preventDefault(),H.keys.left=!0},on_release:function(){return H.keys.left=!1}},{keys:"right",on_keydown:function(a){return a.preventDefault(),H.keys.right=!0},on_release:function(){return H.keys.right=!1}},{keys:"down",on_keydown:function(a){return a.preventDefault(),H.keys.down=!0},on_release:function(){return H.keys.down=!1}},{keys:"up",on_keydown:function(a){return a.preventDefault(),H.keys.up=!0},on_release:function(){return H.keys.up=!1}},{keys:"r",on_keydown:function(){return D.reset()}},{keys:"enter",on_keydown:function(){return D.launch()}}],keypress.register_many(a)},a}(),v=requestAnimationFrame||webkitRequestAnimationFrame||mozRequestAnimationFrame||oRequestAnimationFrame||msRequestAnimationFrame||null,k=function(){function a(){this.statsInit(),this.scale=1}return a.prototype.loop=function(){var b,c;return c=Date.now(),b=c-this.lastFrame,v(a.prototype.loop.bind(this)),this.lastFrame=c,D.statsBegin(),D.update(b),D.statsEnd()},a.prototype.update=function(){},a.prototype.start=function(){return this.lastFrame=Date.now(),this.resize(),this.loop()},a.prototype.resize=function(){return this.scale=window.innerHeight/B.levelHeight,M.setScaleX(this.scale),M.setScaleY(this.scale),M.draw(),document.getElementById("container").style.width=B.levelWidth*this.scale+"px"},a.prototype.statsInit=function(){return this.fps=new Stats,document.body.appendChild(this.fps.domElement)},a.prototype.statsBegin=function(){return this.fps.begin()},a.prototype.statsEnd=function(){return this.fps.end()},a.prototype.reset=function(){return void 0!==J.socket?J.sendReset():void 0},a.prototype.launch=function(){return void 0!==J.socket?J.sendLaunch():void 0},a.prototype.loadAssets=function(){return G.addLoad({name:"cubes",url:"../assets/cubes.jpg"}),G.addLoad({name:"cubes_red",url:"../assets/cubes_red.jpg"}),G.addLoad({name:"cubes_blue",url:"../assets/cubes_blue.jpg"}),G.addLoad({name:"cubes_green",url:"../assets/cubes_green.jpg"}),G.addLoad({name:"bonus",url:"../assets/bonus.png"}),G.addLoad({name:"bg",url:"../assets/bg.jpg"}),G.addLoad({name:"boss",url:"../assets/boss.png"}),G.addLoad({name:"playerSpirteSheet",url:"../assets/playerSpirteSheet.png"}),G.load()},a}(),m=function(){function a(){this.imagesToLoad=[],this.images=[]}return a.prototype.addLoad=function(a){return this.imagesToLoad.push(a)},a.prototype.load=function(){var a,b,c,d,e,f,g,h,i;for(d=this,a=0,e=this.imagesToLoad.length,h=this.imagesToLoad,i=[],f=0,g=h.length;g>f;f++)c=h[f],b=new Image,b.src=c.url,this.images[c.name]=b,i.push(b.onload=function(){return a++,a===e?d.imagesLoaded():void 0});return i},a.prototype.imagesLoaded=function(){},a}(),f=function(){function a(){}return a.prototype.getBoundBox=function(a){return{top:a.getY(),bottom:a.getY()+a.getHeight(),left:a.getX(),right:a.getX()+a.getWidth()}},a.prototype.colliding=function(a,b){return!(a.left>=b.right||a.right<=b.left||a.top>=b.bottom||a.bottom<=b.top)},a.prototype.collidingCorners=function(a,b){return(b.right>=a.left&&b.right<a.right&&b.top>=a.top&&b.top<a.bottom||b.left>=a.left&&b.left<a.right&&b.top>=a.top&&b.top<a.bottom)&&a.top>b.top-5},a}(),q=function(){function a(){this.heightCouched=30,this.height=46,this.draw(),this.spawn()}return a.prototype.draw=function(){var a;return this.shape=new Kinetic.Rect({width:22,height:this.height,stroke:null}),L.add(this.shape),a={idle:[{x:290,y:2,width:46,height:45}],jump:[{x:339,y:2,width:45,height:45}],fall:[{x:387,y:2,width:46,height:45}],run:[{x:0,y:2,width:46,height:45},{x:49,y:2,width:46,height:45},{x:97,y:2,width:46,height:45},{x:145,y:2,width:46,height:45},{x:193,y:2,width:46,height:45},{x:241,y:2,width:46,height:45}],couch:[{x:0,y:63,width:46,height:34}],couchMove:[{x:50,y:67,width:46,height:30},{x:98,y:67,width:46,height:30},{x:146,y:67,width:46,height:30},{x:194,y:67,width:46,height:30},{x:242,y:67,width:46,height:30}],grabbing:[{x:0,y:98,width:46,height:48}]},this.skin=new Kinetic.Sprite({image:G.images.playerSpirteSheet,animation:"run",animations:a,frameRate:7,index:0}),L.add(this.skin),this.skin.start()},a.prototype.spawn=function(){return this.shape.setX(336),this.shape.setY(-1*M.getY())},a.prototype.reset=function(){return this.spawn(),this.alive=!0,this.falling=!0,this.jumpMax=B.playerJumpMax,this.speed=B.playerSpeed,this.jumpHeight=B.playerJumpHeight,this.grabbing=!1,this.canGrab=!1,this.coopJump=!1},a.prototype.resurection=function(){return this.alive?void 0:this.reset()},a.prototype.kill=function(){return this.shape.setX(-64),this.alive=!1,E.reset()},a.prototype.fixSkinPos=function(){return-1===this.skin.getScaleX()?this.skin.setX(this.shape.getX()-12+48):this.skin.setX(this.shape.getX()-12),"couch"===this.skin.getAnimation()?this.skin.setY(this.shape.getY()-4):this.skin.setY(this.shape.getY())},a.prototype.changeAnimation=function(a){return this.skin.getAnimation()!==a?this.skin.setAnimation(a):void 0},a.prototype.changeSide=function(a){return-1===a?(this.skin.setScaleX(-1),this.skin.setX(this.skin.getX()+48)):1===a?(this.skin.setScaleX(1),this.skin.setX(this.skin.getX()-48)):void 0},a}(),g=function(a){function b(){b.__super__.constructor.call(this),this.speed=B.playerSpeed,this.couchedSpeedRatio=.5,this.fallMinAcceleration=.2,this.fallMaxAcceleration=.6,this.fallAcceleration=1.05,this.fallCurrentAcceleration=this.fallMinAcceleration,this.jumpMinAcceleration=.1,this.jumpMaxAcceleration=.6,this.jumpDeceleration=.95,this.jumpCurrentAcceleration=0,this.jumpHeight=B.playerJumpHeight,this.jumpMax=B.playerJumpMax,this.jump=!1,this.canJump=!0,this.jumpStart=0,this.jumpCount=0,this.couched=!1,this.falling=!0,this.grabbing=!1,this.canGrab=!1,this.coopJump=!1,this.alive=!0,this.actualCollisions=[]}return Q(b,a),b.prototype.update=function(a){var b,c,d;return this.alive?(b=this.testDiff(),b&&"falling"===b.getName()?(this.kill(),J.sendDie()):b&&"bonus"===b.getName().type?this.takeBonus(b):b&&"boss"===b.getName().type&&this.collideBoss(b),c=0,this.jump||this.falling||H.keys.left||H.keys.right||H.keys.up||H.keys.down?(this.jump||this.grabbing?this.doJump(a):this.doFall(a),d=this.couched&&!this.jump?this.speed*a*this.couchedSpeedRatio:this.speed*a,H.keys.left&&(b=this.testMove(this.shape.getX()-d,0),b?this.shape.setX(b.getX()+b.getWidth()):c=-1),H.keys.right&&(b=this.testMove(this.shape.getX()+d,0),b?this.shape.setX(b.getX()-this.shape.getWidth()):c=1),H.keys.up?this.canJump&&this.startJump():this.canJump=!0,H.keys.down?this.startCouch():this.stopCouch(),J.sendMove(this.shape.getX(),this.shape.getY())):this.couched?(this.stopCouch(),J.sendMove(this.shape.getX(),this.shape.getY())):H.keys.up||(this.canJump=!0),-1===c&&-1!==this.skin.getScaleX()?this.changeSide(-1):1===c&&1!==this.skin.getScaleX()&&this.changeSide(1),this.jump?this.changeAnimation("jump"):this.grabbing?this.changeAnimation("grabbing"):this.falling?this.changeAnimation("fall"):this.couched?0!==c?this.changeAnimation("couchMove"):this.changeAnimation("couch"):0!==c?this.changeAnimation("run"):this.changeAnimation("idle"),this.fixSkinPos(),this.getCornerCollisions(),HTML.query("#jump").textContent=this.jump,HTML.query("#jumps").textContent=this.jumpCount+"/"+this.jumpMax,HTML.query("#falling").textContent=this.falling,HTML.query("#alive").textContent=this.alive,HTML.query("#ppc").textContent=!(this.jump||this.falling||H.keys.left||H.keys.right||H.keys.up||H.keys.down)):void 0},b.prototype.doFall=function(a){var b,c;return 0===this.jumpCount&&(this.jumpCount=1),b=this.testMove(0,this.shape.getY()+this.fallCurrentAcceleration*a),c=this.fallCurrentAcceleration*this.fallAcceleration,this.fallCurrentAcceleration=c<=this.fallMaxAcceleration?c:this.fallMaxAcceleration,b?this.stopFall(b.getY()):this.falling=!0},b.prototype.stopFall=function(a){return this.shape.setY(a-this.shape.getHeight()),this.jumpCount=0,this.fallCurrentAcceleration=this.fallMinAcceleration,this.falling=!1},b.prototype.startJump=function(){return this.canJump=!1,this.jumpCount<this.jumpMax&&!this.couched?(this.playerCollision()&&(this.coopJump=!0,this.jumpHeight+=40),this.jumpCount++,this.jump=!0,this.jumpCurrentAcceleration=this.jumpMaxAcceleration,this.jumpStart=this.shape.getY()):void 0},b.prototype.doJump=function(a){var b,c;return this.jumpStart-this.shape.getY()<this.jumpHeight&&this.jump?(b=this.testMove(0,this.shape.getY()-this.jumpCurrentAcceleration*a),c=this.jumpCurrentAcceleration*this.jumpDeceleration,this.jumpCurrentAcceleration=c>=this.jumpMinAcceleration?c:this.jumpMinAcceleration,b&&(this.shape.setY(b.getY()+b.getHeight()),this.stopJump()),this.jumpTime+=a):this.stopJump()},b.prototype.stopJump=function(){return this.jump=!1,this.falling=!0,this.coopJump?(this.coopJump=!1,this.jumpHeight-=40):void 0},b.prototype.startCouch=function(){return this.couched||this.grabbing?void 0:(this.couched=!0,this.shape.setHeight(this.heightCouched),this.shape.setY(this.shape.getY()+this.height-this.heightCouched))},b.prototype.stopCouch=function(){var a;return this.couched&&(this.couched=!1,this.shape.setHeight(this.height),a=this.testMove(0,this.shape.getY()-this.height+this.heightCouched))?this.startCouch():void 0},b.prototype.getCollisions=function(){var a,b,c;return c=[],b=A.getBoundBox(this.shape),a=O.find("Sprite"),a.each(function(a){var d;return d=A.getBoundBox(a),A.colliding(b,d)?c.push(a):void 0}),a=C.find("Sprite"),a.each(function(a){var d;return d=A.getBoundBox(a),A.colliding(b,d)?c.push(a):void 0}),c},b.prototype.testMove=function(a,b){var c,d,e,f,g,h,i;for(e=this.getCollisions(),0!==a&&this.shape.setX(a),0!==b&&this.shape.setY(b),d=this.getCollisions(),f=0,h=d.length;h>f;f++)if(c=d[f],R.call(e,c)<0&&(0!==a&&c.getY()!==this.shape.getY()+this.shape.getHeight()||0!==b&&c.getX()!==this.shape.getX()+this.shape.getWidth()&&c.getX()+c.getWidth()!==this.shape.getX())&&(void 0===c.getName()||null===c.getName()||"bonus"!==c.getName().type&&"boss"!==c.getName().type))return c;for(g=0,i=d.length;i>g;g++)c=d[g],R.call(e,c)<0&&void 0!==c.getName()&&null!==c.getName()&&("bonus"===c.getName().type&&this.takeBonus(c),"boss"===c.getName().type&&this.collideBoss(c));return!1},b.prototype.testDiff=function(){var a,b,c,d;for(b=this.getCollisions(),c=0,d=b.length;d>c;c++)if(a=b[c],R.call(this.actualCollisions,a)<0)return this.actualCollisions=b,a;return this.actualCollisions=b,!1},b.prototype.takeBonus=function(a){return x.getBonus(a.getName().name,this,a.getId()),a.destroy(),C.draw(),J.sendBonusTaken(a.getId())},b.prototype.changeAnimation=function(a){return this.skin.getAnimation()!==a?(this.skin.setAnimation(a),J.sendAnimation(a)):void 0},b.prototype.changeSide=function(a){return b.__super__.changeSide.call(this,a),J.sendAnimationSide(a)},b.prototype.collideBoss=function(){return this.kill()},b.prototype.getCornerCollisions=function(){var a,b,c,d;return d=this,a=0,c=A.getBoundBox(this.shape),c.left-=4,c.right+=4,b=C.find("Sprite"),b.each(function(b){var e;return e=A.getBoundBox(b),A.colliding(c,e)&&A.collidingCorners(c,e)?d.canGrab?(d.grab(b),a++):L.find("Rect").each(function(e){var f;return"otherPlayer"===e.getName()&&(f=A.getBoundBox(e),f.bottom+=4,A.colliding(c,f)&&e.getHeight()<d.height)?(d.grab(b),a++):void 0}):void 0}),0===a?this.grabbing=!1:void 0},b.prototype.playerCollision=function(){var a,b;return b=!1,a=A.getBoundBox(this.shape),L.find("Rect").each(function(c){var d;return"otherPlayer"===c.getName()&&(d=A.getBoundBox(c),A.colliding(a,d)&&c.getHeight()<self.height)?b=!0:void 0}),b},b.prototype.grab=function(a){return this.grabbing?void 0:(this.stopJump(),this.grabbing=!0,this.jumpCount=0,this.shape.setY(a.getY()))},b}(q),u=function(a){function b(a){b.__super__.constructor.call(this),this.skin.setFill("white"),this.shape.setName("otherPlayer"),this.name=new Kinetic.Text({text:a,fill:"black",fontFamily:"Calibri",fontSize:18}),L.add(this.name)}return Q(b,a),b.prototype.move=function(a,b){return this.shape.setX(a),this.shape.setY(b),this.name.setX(a),this.name.setY(b-20),this.fixSkinPos()},b.prototype.remove=function(){return this.shape.destroy(),this.skin.destroy(),this.name.destroy(),delete this},b}(q),s={SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},h=function(){function a(a,b,c,d){this.x=a,this.y=b,this.size=c,this.color=d,this.cubesTypes={"32-32":[{x:192,y:96,width:32,height:32}],"64-64":[{x:128,y:64,width:64,height:64}],"128-128":[{x:0,y:0,width:128,height:128}],"64-32":[{x:192,y:64,width:64,height:32}],"128-64":[{x:128,y:0,width:128,height:64}],"32-128":[{x:256,y:0,width:32,height:128}]},this.draw()}return a.prototype.draw=function(){return this.shape=new Kinetic.Sprite({x:this.x,y:this.y,width:this.size.x,height:this.size.y,image:G.images["cubes"+this.color],animation:this.size.x+"-"+this.size.y,animations:this.cubesTypes,frameRate:0,index:0})},a}(),i=function(a){function b(a,c,d){var e,f;e=32*a+160,f=-1*M.getY(),b.__super__.constructor.call(this,e,f,c,this.getColor()),C.add(this.shape),this.shape.setName("falling"),this.shape.draw(),this.destination=w.y-32*d-c.y,this.diffY=this.destination-f,this.speed=600,this.fall()}return Q(b,a),b.prototype.fall=function(){var a,b;return a=this,b=new Kinetic.Tween({node:this.shape,duration:this.diffY/this.speed,y:this.destination,onFinish:function(){return a.shape.setName(null),b.destroy()}}),b.play()},b.prototype.getColor=function(){var a;return a=["_red","_green","_blue"],a[Math.floor(Math.random()*a.length)]},b}(h),t=function(a){function b(a,c,d){b.__super__.constructor.call(this,a,c,d,""),O.add(this.shape),this.shape.draw()}return Q(b,a),b}(h),y={doubleJump:[{x:0,y:0,width:32,height:32}],grabbing:[{x:32,y:0,width:32,height:32}],resurection:[{x:64,y:0,width:32,height:32}],jumpHeight:[{x:0,y:0,width:32,height:32}],speed:[{x:96,y:0,width:32,height:32}]},b=function(){function a(a,b,c,d){this.id=d,this.type=c,this.x=32*a+160,this.y=-1*M.getY(),this.draw(),this.destination=w.y-32*b-32,this.diffY=this.destination-this.y,this.speed=600,this.fall()}return a.prototype.fall=function(){var a;return a=new Kinetic.Tween({node:this.shape,duration:this.diffY/this.speed,y:this.destination}),a.play()},a.prototype.draw=function(){return this.shape=new Kinetic.Sprite({x:this.x,y:this.y,width:32,height:32,image:G.images.bonus,animation:this.type,animations:y,frameRate:0,index:0,name:{type:"bonus",name:this.type},id:"bonus"+this.id}),C.add(this.shape)},a}(),c=function(){function a(){this.bonuses=[{name:"doubleJump",attribute:"jumpCount",value:1,time:3e3},{name:"grabbing",attribute:"canGrab",value:!0,time:1e4},{name:"resurection",attribute:"resurection"},{name:"speed",attribute:"speed",value:.1},{name:"jumpHeight",attribute:"jumpHeight",value:10}],this.timers=[]}return a.prototype.getBonus=function(a,b){var c,d,e,f,g,h,i,j;for(i=this.bonuses,j=[],g=0,h=i.length;h>g;g++)c=i[g],a===c.name?(this.addBonus(c,b),E.addBuff(a,c.time),void 0!==c.time?(e=this,f=c,d=function(){return e.removeBonus(f,b),E.deleteBuff(a)},j.push(this.timers.push(setTimeout(d,c.time)))):j.push(void 0)):j.push(void 0);return j},a.prototype.addBonus=function(a,b){switch(a.attribute){case"speed":return b.speed+=a.value;case"jumpHeight":return b.jumpHeight+=a.value;case"jumpCount":return b.jumpMax+=a.value;case"canGrab":return b.canGrab=!0;case"resurection":return J.sendResurection(),b.resurection()}},a.prototype.removeBonus=function(a,b){switch(a.attribute){case"speed":return b.speed-=a.value;case"jumpHeight":return b.jumpHeight-=a.value;case"jumpCount":return b.jumpMax-=a.value;case"canGrab":return b.canGrab=!1}},a.prototype.reset=function(){var a,b,c,d,e;for(d=this.timers,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(clearInterval(a));return e},a.prototype.remove=function(a){var b;return b=C.find("Sprite"),b.each(function(b){return b.getId()===a?(b.destroy(),C.draw()):void 0})},a}(),o=function(){function a(){this.tweens=[],this.level=0}return a.prototype.reset=function(){var a,b,c,d;for(d=this.tweens,b=0,c=d.length;c>b;b++)a=d[b],void 0!==a&&a.destroy();return M.setY(0),N.setY(0),w.reset(),x.reset(),z.reset(),E.reset(),C.destroyChildren(),M.draw(),this.level=0},a.prototype.moveLevel=function(a){return w.add(a/32),this.tweens[0]=new Kinetic.Tween({node:M,duration:2,y:M.getY()+a*D.scale,onFinish:function(){return J.sendMoveLevelOk()}}),this.tweens[0].play(),this.tweens[1]=new Kinetic.Tween({node:N,duration:2,y:N.getY()-a}),this.tweens[1].play(),this.tweens[2]=new Kinetic.Tween({node:F,duration:2,y:F.getY()-a}),this.tweens[2].play()},a.prototype.clearLevel=function(){var a;return this.level++,HTML.query("#lml").textContent=this.level,w.clearOutOfScreen(),a=C.find("Sprite"),a.each(function(a){return a.getY()>-1*M.getY()+M.getHeight()?a.destroy():void 0}),K.shape.getY()>-1*M.getY()+M.getHeight()?K.kill():void 0},a}(),p=function(){function a(){this.players=[],this.playersId=[]}return a.prototype.connect=function(a,b){return this.socket=io.connect("http://"+a+":8080"),this.socket.emit("login",b),this.listener()},a.prototype.listener=function(){var a;return a=this,this.socket.on("fallingCube",function(a){return new i(a[0],a[1],a[2])}),this.socket.on("fallingBonus",function(a){return new b(a[0],a[1],a[2],a[3])}),this.socket.on("resetLevel",function(){return I.reset(),K.reset()}),this.socket.on("clearLevel",function(){return I.clearLevel()}),this.socket.on("moveLevel",function(a){return I.moveLevel(a)}),this.socket.on("bonusTaken",function(a){return x.remove(a)}),this.socket.on("connection",function(b){return a.players[b[0]]=new u(b[1]),a.playersId.push(b[0])}),this.socket.on("disconnect",function(b){return a.players[b].remove()}),this.socket.on("move",function(b){return void 0!==a.players[b[0]]?a.players[b[0]].move(b[1],b[2]):void 0}),this.socket.on("changeAnimation",function(b){return a.players[b[0]].changeAnimation(b[1])}),this.socket.on("changeAnimationSide",function(b){return a.players[b[0]].changeSide(b[1])}),this.socket.on("kill",function(b){return a.players[b].kill()}),this.socket.on("spawnBoss",function(a){return z.spawn(a[0],a[1])}),this.socket.on("resurection",function(){return K.resurection()}),this.socket.on("playerList",function(b){var c,d,e,f,g,h;for(g=a.playersId,h=[],c=e=0,f=g.length;f>e;c=++e)d=g[c],-1===b.indexOf(d)?(a.players[d].remove(),h.push(a.playersId.splice(c,1))):h.push(void 0);return h})},a.prototype.sendLaunch=function(){return this.socket.emit("launch")},a.prototype.sendReset=function(){return this.socket.emit("reset")},a.prototype.sendMove=function(a,b){return this.socket.emit("move",[parseInt(a),parseInt(b)])},a.prototype.sendDie=function(){return this.socket.emit("die")},a.prototype.sendMoveLevelOk=function(){return this.socket.emit("moveLevelOk")},a.prototype.sendBonusTaken=function(a){return this.socket.emit("bonusTaken",a)},a.prototype.sendAnimation=function(a){return this.socket.emit("changeAnimation",a)},a.prototype.sendAnimationSide=function(a){return this.socket.emit("changeAnimationSide",a)},a.prototype.sendBossBeaten=function(){return this.socket.emit("bossBeaten")},a.prototype.sendResurection=function(){return this.socket.emit("resurection")},a}(),a=function(){function a(){this.y=M.getHeight(),this.initHeight=31,this.height=this.initHeight,this.draw()}return a.prototype.draw=function(){var a,b,c,d,e;for(a=b=0;13>=b;a=++b)new t(32*a+128,this.y,s.SMALL);for(e=[],a=c=0,d=this.height;d>=0?d>=c:c>=d;a=d>=0?++c:--c)new t(128,this.y-32*a,s.SMALL),e.push(new t(544,this.y-32*a,s.SMALL));return e},a.prototype.reset=function(){return this.height=this.initHeight,this.clear(),this.draw()},a.prototype.clear=function(){var a;return a=O.find("Sprite"),a.each(function(a){return a.remove()}),O.draw()},a.prototype.add=function(a){var b,c,d,e;for(b=c=d=this.height,e=this.height+a;e>=d?e>=c:c>=e;b=e>=d?++c:--c)new t(128,this.y-32*b,s.SMALL),new t(544,this.y-32*b,s.SMALL);return this.height+=a},a.prototype.clearOutOfScreen=function(){var a;return a=O.find("Sprite"),a.each(function(a){return a.getY()>-1*M.getY()+M.getHeight()?a.destroy():void 0})},a}(),l=function(){function a(){this.level,this.buffs=[],this.drawLevel()}return a.prototype.update=function(a){var b;return b="Level : "+I.level,b!==this.level.getText()&&this.level.setText(b),this.updateBuffs(a),F.draw()},a.prototype.drawLevel=function(){return this.level=new Kinetic.Text({text:"Level : 0",fill:"black",fontFamily:"Calibri",fontSize:18}),F.add(this.level)},a.prototype.addBuff=function(a,b){var c,d,e;return this.buffs.push({buff:a,time:b}),void 0===F.find("#"+a)[0]?(c=new Kinetic.Sprite({x:618,y:0,width:32,height:32,image:G.images.bonus,animation:a,animations:y,frameRate:0,index:0,id:a}),F.add(c),void 0!==b&&(e=new Kinetic.Text({x:658,y:0,text:b/1e3,fill:"black",fontFamily:"Calibri",fontSize:18,id:"timer"+a,name:"timer"}),F.add(e),e.setAttr("currentTime",b/1e3)),d=new Kinetic.Text({x:590,y:0,text:"1 x ",fill:"black",fontFamily:"Calibri",fontSize:18,id:"count"+a,name:"count"}),F.add(d)):(d=F.find("#count"+a)[0],d.setText(parseInt(d.getText().split(" x "))+1+" x "),void 0!==b?(e=F.find("#timer"+a)[0],e.setText(b/1e3)):void 0)},a.prototype.deleteBuff=function(a){var b,c,d;if(b=F.find("#"+a)[0],c=F.find("#count"+a)[0],d=F.find("#timer"+a)[0],void 0!==b)if(void 0!==c){if("1 x "!==c.getText())return c.setText(parseInt(c.getText().split(" x "))-1+" x ");if(b.destroy(),c.destroy(),void 0!==d)return d.destroy()}else if(b.destroy(),c.destroy(),void 0!==d)return d.destroy()},a.prototype.updateBuffs=function(a){var b;return b=0,F.find("Sprite").each(function(a){var c,d;return d=F.find("#timer"+a.getId())[0],void 0!==d&&d.setY(b+8),c=F.find("#count"+a.getId())[0],void 0!==c&&c.setY(b+8),a.setY(b),b+=40}),F.find("Text").each(function(b){var c;return"timer"===b.getName()?(c=b.getAttr("currentTime")-a/1e3,0>c&&(c=0),b.setAttr("currentTime",c),b.setText(Math.round(100*c)/100)):void 0})},a.prototype.reset=function(){return F.find("Text").each(function(a){return"timer"===a.getName()||"count"===a.getName()?a.destroy():void 0}),F.find("Sprite").each(function(a){return a.destroy()})},a}(),d=function(){function a(a,b,c,d,e,f){this.id=a,this.type=b,this.x=c,this.y=d,this.w=e,this.h=f,this.bossTypes={roueman:[{x:0,y:0,width:64,height:64},{x:64,y:0,width:64,height:64},{x:128,y:0,width:64,height:64}],freezeman:[{x:0,y:64,width:544,height:32}]},this.draw()}return a.prototype.draw=function(){return this.shape=new Kinetic.Sprite({x:this.x,y:this.y,width:this.w,height:this.h,image:G.images.boss,animation:this.type,animations:this.bossTypes,frameRate:10,index:0,name:{type:"boss",name:this.type},id:"boss"+this.id,stroke:"black",strokeWidth:1,strokeEnabled:!0}),C.add(this.shape),this.shape.start()},a.prototype.finish=function(){return this.shape.destroy(),C.draw(),J.sendBossBeaten()},a.prototype.reset=function(){return this.shape.destroy(),C.draw()},a}(),e=function(){function a(){this.currentBoss,this.tweens=[]}return a.prototype.spawn=function(a,b){return"roueman"===a&&(this.currentBoss=new r(0,b)),"freezeman"===a?this.currentBoss=new j(0,b):void 0},a.prototype.reset=function(){var a,b,c,d;for(d=this.tweens,b=0,c=d.length;c>b;b++)a=d[b],a.destroy();return this.tweens=[],void 0!==this.currentBoss?this.currentBoss.reset():void 0},a}(),r=function(a){function b(a,c){var d;d=-1*M.getY()+B.levelHeight-160,b.__super__.constructor.call(this,a,"roueman",0,d,64,64),this.attacks=c,this.index=0,this.loop()}return Q(b,a),b.prototype.attack=function(a){var b,c;return b=this,z.tweens.push(c=new Kinetic.Tween({node:this.shape,duration:.1,y:-1*M.getY()+B.levelHeight-32*a,onFinish:function(){var a;return z.tweens.push(a=new Kinetic.Tween({node:b.shape,duration:1,x:B.levelWidth-64,onFinish:function(){var a;return z.tweens.push(a=new Kinetic.Tween({node:b.shape,duration:.1,y:-1*M.getY()+B.levelHeight-128,onFinish:function(){var a;return z.tweens.push(a=new Kinetic.Tween({node:b.shape,duration:.5,x:0,onFinish:function(){return b.loop()}})),a.play()}})),a.play()}})),a.play()}})),c.play()},b.prototype.loop=function(){return void 0!==this.attacks[this.index]?(this.attack(this.attacks[this.index]),this.index++):this.finish()},b}(d),j=function(){function a(a){var b,c,e;for(this.count=4,this.intervalTime=700,this.parts=[],b=c=0,e=this.count-1;e>=0?e>=c:c>=e;b=e>=0?++c:--c)this.parts.push(new d(a,"freezeman",-544,0,544,32));this.freeWidth=64,this.top=-1*M.getY()-128,this.attacks=[[10,10,26,10],[19,19,19,10],[10,10,29,10]],this.index=0,this.subIndex=0,this.start()}return a.prototype.attack=function(a,b){var c;return this.parts[b].shape.setX(128+32*a-544+32),this.parts[b].shape.setY(this.top),z.tweens.push(c=new Kinetic.Tween({node:this.parts[b].shape,duration:2,y:-1*M.getY()+B.levelHeight})),c.play()},a.prototype.loop=function(){return void 0!==this.attacks[this.index]?void 0!==this.attacks[this.index][this.subIndex]?(this.attack(this.attacks[this.index][this.subIndex],this.subIndex),this.subIndex++):(this.index++,this.subIndex=0):(clearInterval(this.interval),this.finish())},a.prototype.start=function(){var a,b;return a=this,b=function(){return a.loop()},this.interval=setInterval(b,this.intervalTime)},a.prototype.reset=function(){var a,b,c,d,e;for(d=this.parts,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.reset());return e},a.prototype.finish=function(){var a,b,c,d;for(d=this.parts,b=0,c=d.length;c>b;b++)a=d[b],a.shape.destroy();return C.draw(),J.sendBossBeaten()},a}(),M=new Kinetic.Stage({container:"container",width:B.levelWidth,height:B.levelHeight}),C=new Kinetic.Layer,L=new Kinetic.Layer,O=new Kinetic.Layer,N=new Kinetic.Layer,F=new Kinetic.Layer,M.add(N),M.add(O),M.add(L),M.add(C),M.add(F),J=new p,G=new m,A=new f,H=new n,I=new o,x=new c,z=new e,D=new k,D.loadAssets(),w=null,K=null,E=null,G.imagesLoaded=function(){var b;return b=function(b,c){var d;return d=new Kinetic.Rect({width:M.getWidth(),height:M.getHeight(),fillPatternImage:G.images.bg}),N.add(d),d.setZIndex(-1),d.draw(),w=new a,K=new g,E=new l,J.connect(b,c),z.spawn("freezeman"),D.update=function(a){var b;return L.draw(),K.update(a),E.update(a),b=C.find("Sprite"),HTML.query("#cc").textContent=b.length,b=O.find("Sprite"),HTML.query("#sc").textContent=b.length},D.start()},document.getElementById("play").onclick=function(){return document.getElementById("login").style.display="none",b(document.getElementById("ip").value,document.getElementById("name").value)}},window.onresize=function(){return D.resize()}}).call(this);