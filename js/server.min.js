(function(){var a,b,c,d,e,f,g,h,i,j,k,l;h={FPS:60,levelSpeed:1e3,timeout:5e3},c=function(){function a(){this.lastFrame=Date.now()}return a.prototype.loop=function(){var a,b;return b=Date.now(),a=b-this.lastFrame,this.lastFrame=b,this.update(a)},a.prototype.reset=function(){return k.reset()},a.prototype.launch=function(){return k.launch()},a}(),f={SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},b=function(){function a(){this.map=[],this.resetMap(),this.updateRate=0,this.current=0,this.levelHeight=0,this.running=!1,this.waiting=!1,this.bonusId=0,this.types=[{proba:5,size:f.SMALL,width:f.SMALL.x/32,height:f.SMALL.y/32,bonus:"doubleJump"},{proba:5,size:f.LARGE,width:f.LARGE.x/32,height:f.LARGE.y/32},{proba:20,size:f.MEDIUM,width:f.MEDIUM.x/32,height:f.MEDIUM.y/32},{proba:15,size:f.SMALL,width:f.SMALL.x/32,height:f.SMALL.y/32},{proba:10,size:f.MEDIUM_RECT,width:f.MEDIUM_RECT.x/32,height:f.MEDIUM_RECT.y/32},{proba:5,size:f.LARGE_RECT,width:f.LARGE_RECT.x/32,height:f.LARGE_RECT.y/32},{proba:5,size:f.LONG_RECT,width:f.LONG_RECT.x/32,height:f.LONG_RECT.y/32}]}return a.prototype.start=function(a,b){return this.running||this.waiting?void 0:(this.updateRate=b,this.current=0,this.levelHeight+=a,this.running=!0)},a.prototype.reset=function(){return this.levelHeight=0,this.stop(),this.waiting=!1,this.bonusId=0,this.resetMap()},a.prototype.stop=function(){return this.running=!1},a.prototype.wait=function(){return this.stop(),this.waiting=!0,k.update()},a.prototype.resetMap=function(){var a,b,c;for(c=[],a=b=0;11>=b;a=++b)c.push(this.map[a]=0);return c},a.prototype.sendCube=function(){var a,b,c,d,e,f,g,h,i,j;if(b=this.checkCols(),b.length>0){if(f=this.randomizeType(b),g=f.type,h=f.index,d=b[h].length,e=Math.floor(Math.random()*d),a=b[h][e],void 0!==g.bonus)l.sendBonus(a.column,g.bonus,a.height,this.bonusId),this.bonusId++;else for(l.sendCube(a.column,g.size,a.height),c=i=1,j=g.width;j>=1?j>=i:i>=j;c=j>=1?++i:--i)this.map[a.column+c-1]=a.height+g.height;return!0}return!1},a.prototype.randomizeType=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(e=[],t=this.types,k=l=0,p=t.length;p>l;k=++l)j=t[k],void 0!==a[k]&&a[k].length>0&&e.push({type:j,index:k,proba:j.proba});if(e.length!==this.types.length)for(i=this.types.length/e.length,m=0,q=e.length;q>m;m++)d=e[m],d.proba*=i;for(h=[],g=0,b=n=0,r=e.length;r>n;b=++n)d=e[b],g+=d.proba,h.push({index:b,percent:g});for(f=Math.floor(Math.random()*g)+1,o=0,s=h.length;s>o;o++)if(c=h[o],f<=c.percent)return e[c.index];return e[h.length-1]},a.prototype.update=function(a){return this.running&&(this.current+=a,this.current>=this.updateRate&&(this.current=0,!this.sendCube()))?this.wait():void 0},a.prototype.checkCols=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(a=[],o=this.map,c=j=0,m=o.length;m>j;c=++j)for(b=o[c],p=this.types,i=k=0,n=p.length;n>k;i=++k){for(h=p[i],f=!0,e=0,d=l=1,q=h.width;q>=1?q>=l:l>=q;d=q>=1?++l:--l){if(g=this.map[c+d-1],!(g+h.height<=this.levelHeight)){f=!1;break}g>e&&(e=g)}f&&(void 0===a[i]&&(a[i]=[]),a[i].push({column:c,height:e}))}return a},a}(),d=function(){function a(){this.level=0,this.speed=h.levelSpeed,this.tweens=[],this.lastHeight=0}return a.prototype.launch=function(){return this.nextLevel()},a.prototype.reset=function(){return l.sendResetLevel(),i.reset(),clearTimeout(l.timeout),this.level=0,this.speed=h.levelSpeed,this.bossRound=!1},a.prototype.moveStage=function(){var a;return a=32*this.lastHeight,l.moveLevel(a)},a.prototype.update=function(){return this.level++,this.speed-=50,this.moveStage()},a.prototype.randomizeHeight=function(){return Math.floor(3*Math.random()+4)},a.prototype.nextLevel=function(){return i.running?void 0:(clearTimeout(l.timeout),this.clearLevel(),this.lastHeight=this.randomizeHeight(),i.start(this.lastHeight,this.speed))},a.prototype.clearLevel=function(){return l.sendClearLevel()},a.prototype.nextBoss=function(){return g.launched?void 0:(clearTimeout(l.timeout),g.launch())},a.prototype.passNextLevel=function(){return i.waiting=!1,g.launched=!1,k.nextLevel()},a}(),e=function(){function a(){this.io=require("socket.io").listen(8080),this.players=[],this.playersCached=[],this.playersIds=[],this.currentId=0,this.waitingFor=0,this.responseOk=0,this.listener()}return a.prototype.listener=function(){var a;return a=this,this.io.sockets.on("connection",function(b){var c,d,e,f,g,h,i;for(d=[],i=a.playersIds,e=0,g=i.length;g>e;e++)c=i[e],void 0!==a.players[c]?(b.emit("connection",[c,a.players[c].name]),b.emit("move",[c,a.players[c].x,a.players[c].y])):d.push(c);for(f=0,h=d.length;h>f;f++)c=d[f],delete a.playersIds[c];return c=a.currentId.toString(32),a.currentId++,a.playersIds.push(c),a.players[c]={name:"Chy"},b.broadcast.emit("connection",[c,a.players[c].name]),b.on("launch",function(){return j.launch()}),b.on("reset",function(){return j.reset(),a.sendResetLevel()}),b.on("move",function(b){return a.players[c].x=parseInt(b[0]),a.players[c].y=parseInt(b[1])}),b.on("die",function(){return b.broadcast.emit("kill",c)}),b.on("changeAnimation",function(a){return b.broadcast.emit("changeAnimation",[c,a])}),b.on("changeAnimationSide",function(a){return b.broadcast.emit("changeAnimationSide",[c,a])}),b.on("moveLevelOk",function(){return a.responseOk++,a.responseOk>=a.waitingFor?k.nextBoss():void 0}),b.on("bonusTaken",function(a){return b.broadcast.emit("bonusTaken",a)}),b.on("bossBeaten",function(){return a.responseOk++,a.responseOk>=a.waitingFor?k.passNextLevel():void 0}),b.on("disconnect",function(){return b.broadcast.emit("disconnect",c),delete a.players[c]})})},a.prototype.sendCube=function(a,b,c){return this.io.sockets.emit("fallingCube",[a,b,c])},a.prototype.sendBonus=function(a,b,c,d){return this.io.sockets.emit("fallingBonus",[a,c,b,d])},a.prototype.sendResetLevel=function(){return this.io.sockets.emit("resetLevel")},a.prototype.sendClearLevel=function(){return this.io.sockets.emit("clearLevel")},a.prototype.moveLevel=function(a){return this.waitForAll(k.nextBoss,h.timeout),this.io.sockets.emit("moveLevel",a)},a.prototype.sendBoss=function(a,b,c){return this.waitForAll(k.passNextLevel,h.timeout+c),this.io.sockets.emit("spawnBoss",[a,b])},a.prototype.sendPositions=function(){var a,b,c,d,e;for(d=this.playersIds,e=[],b=0,c=d.length;c>b;b++)a=d[b],void 0===this.players[a]||void 0!==this.playersCached[a]&&this.playersCached[a].x===this.players[a].x&&this.playersCached[a].y===this.players[a].y?e.push(void 0):(this.io.sockets.emit("move",[a,this.players[a].x,this.players[a].y]),e.push(this.playersCached[a]={x:this.players[a].x,y:this.players[a].y}));return e},a.prototype.waitForAll=function(a,b){return this.waitingFor=this.players.length,this.responseOk=0,this.timeout=setTimeout(a,b)},a}(),a=function(){function a(){this.launched=!1}return a.prototype.launch=function(){return l.sendBoss("roueman",[3,1,1,3,3],15e3),this.launched=!0},a}(),l=new e,j=new c,i=new b,k=new d,g=new a,setInterval(function(){return j.loop()},1e3/h.FPS),j.update=function(a){return i.update(a),l.sendPositions()}}).call(this);