(function(){var a,b,c,d,e,f,g,h,i,j;f={FPS:30,levelSpeed:1e3},b=function(){function a(){this.lastFrame=Date.now()}return a.prototype.loop=function(){var a,b;return b=Date.now(),a=b-this.lastFrame,this.lastFrame=b,this.update(a)},a.prototype.reset=function(){return i.reset()},a.prototype.launch=function(){return i.launch()},a}(),e={SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},a=function(){function a(){this.map=[],this.resetMap(),this.updateRate=0,this.current=0,this.levelHeight=0,this.running=!1,this.waiting=!1,this.types=[{proba:8,size:e.LARGE,width:e.LARGE.x/32,height:e.LARGE.y/32},{proba:26,size:e.MEDIUM,width:e.MEDIUM.x/32,height:e.MEDIUM.y/32},{proba:26,size:e.SMALL,width:e.SMALL.x/32,height:e.SMALL.y/32},{proba:16,size:e.MEDIUM_RECT,width:e.MEDIUM_RECT.x/32,height:e.MEDIUM_RECT.y/32},{proba:8,size:e.LARGE_RECT,width:e.LARGE_RECT.x/32,height:e.LARGE_RECT.y/32},{proba:16,size:e.LONG_RECT,width:e.LONG_RECT.x/32,height:e.LONG_RECT.y/32}]}return a.prototype.start=function(a,b){return this.running||this.waiting?void 0:(this.updateRate=b,this.current=0,this.levelHeight+=a,this.running=!0)},a.prototype.reset=function(){return this.levelHeight=0,this.stop(),this.waiting=!1,this.resetMap()},a.prototype.stop=function(){return this.running=!1},a.prototype.wait=function(){return this.stop(),this.waiting=!0,i.update()},a.prototype.resetMap=function(){var a,b,c;for(c=[],a=b=0;11>=b;a=++b)c.push(this.map[a]=0);return c},a.prototype.sendCube=function(){var a,b,c,d,e,f,g,h,i,k;if(b=this.checkCols(),b.length>0){for(f=this.randomizeType(b),g=f.type,h=f.index,d=b[h].length,e=Math.floor(Math.random()*d),a=b[h][e],j.sendCube(a.column,g.size,a.height),c=i=1,k=g.width;k>=1?k>=i:i>=k;c=k>=1?++i:--i)this.map[a.column+c-1]=a.height+g.height;return!0}return!1},a.prototype.randomizeType=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(e=[],t=this.types,k=l=0,p=t.length;p>l;k=++l)j=t[k],void 0!==a[k]&&a[k].length>0&&e.push({type:j,index:k,proba:j.proba});if(e.length!==this.types.length)for(i=this.types.length/e.length,m=0,q=e.length;q>m;m++)d=e[m],d.proba*=i;for(h=[],g=0,b=n=0,r=e.length;r>n;b=++n)d=e[b],g+=d.proba,h.push({index:b,percent:g});for(f=Math.floor(100*Math.random())+1,o=0,s=h.length;s>o;o++)if(c=h[o],f<=c.percent)return e[c.index];return e[h.length-1]},a.prototype.update=function(a){return this.running&&(this.current+=a,this.current>=this.updateRate&&(this.current=0,!this.sendCube()))?this.wait():void 0},a.prototype.checkCols=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(a=[],o=this.map,c=j=0,m=o.length;m>j;c=++j)for(b=o[c],p=this.types,i=k=0,n=p.length;n>k;i=++k){for(h=p[i],f=!0,e=0,d=l=1,q=h.width;q>=1?q>=l:l>=q;d=q>=1?++l:--l){if(g=this.map[c+d-1],!(g+h.height<=this.levelHeight)){f=!1;break}g>e&&(e=g)}f&&(void 0===a[i]&&(a[i]=[]),a[i].push({column:c,height:e}))}return a},a}(),c=function(){function a(){this.level=0,this.speed=f.levelSpeed,this.tweens=[],this.lastHeight=0}return a.prototype.launch=function(){return this.nextLevel()},a.prototype.reset=function(){return j.sendResetLevel(),g.reset(),this.level=0,this.speed=f.levelSpeed},a.prototype.moveStage=function(){var a;return a=32*this.lastHeight,j.moveLevel(a)},a.prototype.update=function(){return this.level++,this.speed-=50,this.moveStage()},a.prototype.randomizeHeight=function(){return Math.floor(3*Math.random()+4)},a.prototype.nextLevel=function(){return g.running?void 0:(this.clearLevel(),this.lastHeight=this.randomizeHeight(),g.start(this.lastHeight,this.speed))},a.prototype.clearLevel=function(){return j.sendClearLevel()},a}(),d=function(){function a(){this.io=require("socket.io").listen(8080),this.players=[],this.playersIds=[],this.listener()}return a.prototype.listener=function(){var a;return a=this,this.io.sockets.on("connection",function(b){var c,d,e,f,j,k,l;for(d=[],l=a.playersIds,e=0,j=l.length;j>e;e++)c=l[e],void 0!==a.players[c]?(b.emit("connection",[c,a.players[c].name]),b.emit("move",[c,a.players[c].x,a.players[c].y])):d.push(c);for(f=0,k=d.length;k>f;f++)c=d[f],delete a.playersIds[c];return c=b.id,a.playersIds.push(c),a.players[c]={name:"Chy"},b.broadcast.emit("connection",[c,a.players[c].name]),b.on("launch",function(){return h.launch()}),b.on("reset",function(){return h.reset(),a.sendResetLevel()}),b.on("move",function(d){return a.players[c].x=parseInt(d[0]),a.players[c].y=parseInt(d[1]),b.broadcast.emit("move",[c,a.players[c].x,a.players[c].y])}),b.on("die",function(){return b.broadcast.emit("kill",c)}),b.on("moveLevelOk",function(){return g.waiting=!1,i.nextLevel()}),b.on("disconnect",function(){return b.broadcast.emit("disconnect",b.id),delete a.players[b.id]})})},a.prototype.sendCube=function(a,b,c){return this.io.sockets.emit("fallingCube",[a,b,c])},a.prototype.sendResetLevel=function(){return this.io.sockets.emit("resetLevel")},a.prototype.sendClearLevel=function(){return this.io.sockets.emit("clearLevel")},a.prototype.moveLevel=function(a){return this.io.sockets.emit("moveLevel",a)},a}(),j=new d,h=new b,g=new a,i=new c,setInterval(function(){return h.loop()},1e3/f.FPS),h.update=function(a){return g.update(a)}}).call(this);