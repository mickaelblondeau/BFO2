(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q={}.hasOwnProperty,r=function(a,b){function c(){this.constructor=a}for(var d in b)q.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};k={FPS:60,lowFPS:.1,levelSpeed:1e3,timeout:5e3},e=function(){function a(){this.lastFrame=Date.now()}return a.prototype.loop=function(){var a,b;return b=Date.now(),a=b-this.lastFrame,this.lastFrame=b,this.update(a)},a.prototype.reset=function(){return n.reset()},a.prototype.launch=function(){return n.launch()},a}(),i={SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},c=function(){function a(){this.map=[],this.resetMap(),this.updateRate=0,this.current=0,this.levelHeight=0,this.running=!1,this.waiting=!1,this.bonusId=0,this.types=[{proba:3,size:i.MEDIUM,width:i.MEDIUM.x/32,height:i.MEDIUM.y/32,special:"iceExplosion"},{proba:3,size:i.MEDIUM,width:i.MEDIUM.x/32,height:i.MEDIUM.y/32,special:"explosion"},{proba:2,size:i.SMALL,width:i.SMALL.x/32,height:i.SMALL.y/32,bonus:"speed"},{proba:2,size:i.SMALL,width:i.SMALL.x/32,height:i.SMALL.y/32,bonus:"jumpHeight"},{proba:2,size:i.SMALL,width:i.SMALL.x/32,height:i.SMALL.y/32,bonus:"doubleJump"},{proba:2,size:i.SMALL,width:i.SMALL.x/32,height:i.SMALL.y/32,bonus:"grabbing"},{proba:5,size:i.LARGE,width:i.LARGE.x/32,height:i.LARGE.y/32},{proba:20,size:i.MEDIUM,width:i.MEDIUM.x/32,height:i.MEDIUM.y/32},{proba:15,size:i.SMALL,width:i.SMALL.x/32,height:i.SMALL.y/32},{proba:10,size:i.MEDIUM_RECT,width:i.MEDIUM_RECT.x/32,height:i.MEDIUM_RECT.y/32},{proba:5,size:i.LARGE_RECT,width:i.LARGE_RECT.x/32,height:i.LARGE_RECT.y/32},{proba:5,size:i.LONG_RECT,width:i.LONG_RECT.x/32,height:i.LONG_RECT.y/32}]}return a.prototype.start=function(a,b){return this.running||this.waiting?void 0:(0!==n.level&&(o.sendBonus(4,"resurection",this.map[4],this.bonusId),this.bonusId++),this.updateRate=b,this.current=0,this.levelHeight+=a,this.running=!0)},a.prototype.reset=function(){return this.levelHeight=0,this.stop(),this.waiting=!1,this.bonusId=0,this.resetMap()},a.prototype.stop=function(){return this.running=!1},a.prototype.wait=function(){return this.stop(),this.waiting=!0,n.update()},a.prototype.resetMap=function(){var a,b,c;for(c=[],a=b=0;11>=b;a=++b)c.push(this.map[a]=0);return c},a.prototype.sendCube=function(){var a,b,c,d,e,f,g,h,i,j;if(b=this.checkCols(),b.length>0){if(f=this.randomizeType(b),g=f.type,h=f.index,d=b[h].length,e=Math.floor(Math.random()*d),a=b[h][e],void 0!==g.bonus)o.sendBonus(a.column,g.bonus,a.height,this.bonusId),this.bonusId++;else if(void 0!==g.special)"explosion"===g.special&&this.explodeMap(a.column,a.height),o.sendSpecial(a.column,g.size,a.height,g.special);else for(o.sendCube(a.column,g.size,a.height),c=i=1,j=g.width;j>=1?j>=i:i>=j;c=j>=1?++i:--i)this.map[a.column+c-1]=a.height+g.height;return!0}return!1},a.prototype.randomizeType=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(e=[],t=this.types,k=l=0,p=t.length;p>l;k=++l)j=t[k],void 0!==a[k]&&a[k].length>0&&e.push({type:j,index:k,proba:j.proba});if(e.length!==this.types.length)for(i=this.types.length/e.length,m=0,q=e.length;q>m;m++)d=e[m],d.proba*=i;for(h=[],g=0,b=n=0,r=e.length;r>n;b=++n)d=e[b],g+=d.proba,h.push({index:b,percent:g});for(f=Math.floor(Math.random()*g)+1,o=0,s=h.length;s>o;o++)if(c=h[o],f<=c.percent)return e[c.index];return e[h.length-1]},a.prototype.update=function(a){return this.running&&(this.current+=a,this.current>=this.updateRate&&(this.current=0,!this.sendCube()))?this.wait():void 0},a.prototype.checkCols=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(a=[],o=this.map,c=j=0,m=o.length;m>j;c=++j)for(b=o[c],p=this.types,i=k=0,n=p.length;n>k;i=++k){for(h=p[i],f=!0,e=0,d=l=1,q=h.width;q>=1?q>=l:l>=q;d=q>=1?++l:--l){if(g=this.map[c+d-1],!(g+h.height<=this.levelHeight)){f=!1;break}g>e&&(e=g)}f&&(void 0===a[i]&&(a[i]=[]),a[i].push({column:c,height:e}))}return a},a.prototype.explodeMap=function(a,b){var c,d,e,f,g,h;for(h=[],c=g=-4;5>=g;c=++g)e=c>0?c-1:c,d=a+c,d>=0&&(f=parseInt(this.map[d])+parseInt(-5+Math.abs(e)),this.map[d]<b+-1*parseInt(-5+Math.abs(e))&&(this.map[d]=0>f?0:f)),h.push(console.log(this.map));return h},a}(),f=function(){function a(){this.level=0,this.speed=k.levelSpeed,this.tweens=[],this.lastHeight=0}return a.prototype.launch=function(){return this.nextLevel()},a.prototype.reset=function(){return o.sendResetLevel(),l.reset(),j.reset(),clearTimeout(o.timeout),this.level=0,this.speed=k.levelSpeed,this.bossRound=!1},a.prototype.moveStage=function(){var a;return a=32*this.lastHeight,o.moveLevel(a)},a.prototype.update=function(){return this.level++,this.speed-=50,this.moveStage()},a.prototype.randomizeHeight=function(){return Math.floor(3*Math.random()+4)},a.prototype.nextLevel=function(){return l.running?void 0:(clearTimeout(o.timeout),this.clearLevel(),this.lastHeight=this.randomizeHeight(),l.start(this.lastHeight,this.speed))},a.prototype.clearLevel=function(){return o.sendClearLevel()},a.prototype.nextBoss=function(){return j.launched?void 0:(clearTimeout(o.timeout),j.launch())},a.prototype.passNextLevel=function(){return l.waiting=!1,j.launched=!1,n.nextLevel()},a}(),g=function(){function a(){this.io=require("socket.io").listen(8080),this.waitingFor=0,this.responseOk=0,this.listener()}return a.prototype.listener=function(){var a;return a=this,this.io.sockets.on("connection",function(b){var c,d,e,f;for(d=a.io.sockets.clients(),e=0,f=d.length;f>e;e++)c=d[e],c.id!==b.id&&(c.get("name",function(a,d){return b.emit("connection",[c.id,d])}),c.get("position",function(a,d){return null!==d?b.emit("move",[c.id,d.x,d.y]):void 0}));return b.on("login",function(a){return b.set("name",a),b.broadcast.emit("connection",[b.id,a])}),b.on("launch",function(){return m.launch()}),b.on("reset",function(){return m.reset(),a.sendResetLevel()}),b.on("move",function(a){return b.set("position",{x:parseInt(a[0]),y:parseInt(a[1])})}),b.on("die",function(){return b.broadcast.emit("kill",b.id)}),b.on("changeAnimation",function(a){return b.broadcast.emit("changeAnimation",[b.id,a])}),b.on("changeAnimationSide",function(a){return b.broadcast.emit("changeAnimationSide",[b.id,a])}),b.on("moveLevelOk",function(){return a.responseOk++,a.responseOk>=a.waitingFor?n.nextBoss():void 0}),b.on("bonusTaken",function(a){return b.broadcast.emit("bonusTaken",a)}),b.on("bossBeaten",function(){return a.responseOk++,a.responseOk>=a.waitingFor?n.passNextLevel():void 0}),b.on("resurection",function(){return b.broadcast.emit("resurection")}),b.on("message",function(a){return b.broadcast.emit("message",[b.id,a])}),b.on("disconnect",function(){return b.broadcast.emit("disconnect",b.id)})})},a.prototype.sendCube=function(a,b,c){return this.io.sockets.emit("fallingCube",[a,b,c])},a.prototype.sendBonus=function(a,b,c,d){return this.io.sockets.emit("fallingBonus",[a,c,b,d])},a.prototype.sendSpecial=function(a,b,c,d){return this.io.sockets.emit("fallingSpecial",[a,b,c,d])},a.prototype.sendResetLevel=function(){return this.io.sockets.emit("resetLevel")},a.prototype.sendClearLevel=function(){return this.io.sockets.emit("clearLevel")},a.prototype.moveLevel=function(a){return this.waitForAll(n.nextBoss,k.timeout),this.io.sockets.emit("moveLevel",a)},a.prototype.sendBoss=function(a,b,c){return this.waitForAll(n.passNextLevel,k.timeout+c),this.sendClearLevel(),this.io.sockets.emit("spawnBoss",[a,b])},a.prototype.sendPositions=function(){var a,b,c,d,e,f;for(c=this,b=this.io.sockets.clients(),f=[],d=0,e=b.length;e>d;d++)a=b[d],f.push(a.get("position",function(b,d){return null!==d?a.get("oldPosition",function(b,e){return null===e||e!==d?(c.io.sockets.emit("move",[a.id,d.x,d.y]),a.set("oldPosition",d)):void 0}):void 0}));return f},a.prototype.waitForAll=function(a,b){return this.waitingFor=this.io.sockets.clients().length,this.responseOk=0,this.timeout=setTimeout(a,b)},a.prototype.sendPlayerList=function(){var a,b,c,d,e;for(a=[],c=this.io.sockets.clients(),d=0,e=c.length;e>d;d++)b=c[d],a.push(b.id);return this.io.sockets.emit("playerList",a)},a}(),a=function(){function a(a,b,c){this.timeout=b,this.name=a,this.options=c}return a}(),b=function(){function a(){this.launched=!1,this.boss=["roueman","freezeman"]}return a.prototype.launch=function(){var a;return a=this.getBoss(),o.sendBoss(a.name,a.options,a.timeout),this.launched=!0},a.prototype.reset=function(){return this.launched=!1},a.prototype.getBoss=function(){var a;return a=this.boss[Math.floor(Math.random()*this.boss.length)],"roueman"===a?new h:"freezeman"===a?new d:void 0},a}(),h=function(a){function b(){b.__super__.constructor.call(this,"roueman",15e3,this.getPattern())}return r(b,a),b.prototype.getPattern=function(){var a,b,c,d;for(a=[],b=d=0;5>=d;b=++d)c=Math.floor(100*Math.random()+1),a.push(c>=50?3:1);return a},b}(a),d=function(a){function b(){b.__super__.constructor.call(this,"freezeman",15e3,this.getPattern())}return r(b,a),b.prototype.getPattern=function(){var a,b,c,d;for(b=[],c=d=0;5>=d;c=++d)a=Math.floor(10*Math.random()+1),b.push(c%2===0?-16+a:3+a);return b},b}(a),o=new g,m=new e,l=new c,n=new f,j=new b,setInterval(function(){return m.loop()},1e3/k.FPS),setInterval(function(){return p()},1e3/k.lowFPS),m.update=function(a){return l.update(a),o.sendPositions()},p=function(){return o.sendPlayerList()}}).call(this);