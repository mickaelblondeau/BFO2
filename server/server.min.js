(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r={}.hasOwnProperty,s=function(a,b){function c(){this.constructor=a}for(var d in b)r.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};l={FPS:60,lowFPS:.1,levelSpeed:1e3,speedPerLevel:50,timeout:5e3,debug:!1,debugMap:!1},e=function(){function a(){this.lastFrame=Date.now()}return a.prototype.loop=function(){var a,b;return b=Date.now(),a=b-this.lastFrame,this.lastFrame=b,this.update(a)},a.prototype.reset=function(){return o.reset()},a.prototype.launch=function(){return o.launch()},a}(),j={SMALL:{x:32,y:32},MEDIUM:{x:64,y:64},LARGE:{x:128,y:128},MEDIUM_RECT:{x:64,y:32},LARGE_RECT:{x:128,y:64},LONG_RECT:{x:32,y:128}},c=function(){function a(){this.map=[],this.cubeMap=[],this.resetMap(),this.updateRate=0,this.current=0,this.levelHeight=0,this.running=!1,this.waiting=!1,this.bonusId=0,this.types=[{proba:2,size:j.MEDIUM,width:j.MEDIUM.x/32,height:j.MEDIUM.y/32,special:"iceExplosion"},{proba:2,size:j.MEDIUM,width:j.MEDIUM.x/32,height:j.MEDIUM.y/32,special:"explosion"},{proba:2,size:j.MEDIUM,width:j.MEDIUM.x/32,height:j.MEDIUM.y/32,special:"slowblock"},{proba:2,size:j.MEDIUM,width:j.MEDIUM.x/32,height:j.MEDIUM.y/32,special:"stompblock"},{proba:2,size:j.SMALL,width:j.SMALL.x/32,height:j.SMALL.y/32,bonus:"speed",bonusId:1},{proba:2,size:j.SMALL,width:j.SMALL.x/32,height:j.SMALL.y/32,bonus:"jumpHeight",bonusId:2},{proba:2,size:j.SMALL,width:j.SMALL.x/32,height:j.SMALL.y/32,bonus:"doubleJump",bonusId:3},{proba:2,size:j.SMALL,width:j.SMALL.x/32,height:j.SMALL.y/32,bonus:"grabbing",bonusId:4},{proba:5,size:j.LARGE,width:j.LARGE.x/32,height:j.LARGE.y/32},{proba:20,size:j.MEDIUM,width:j.MEDIUM.x/32,height:j.MEDIUM.y/32},{proba:15,size:j.SMALL,width:j.SMALL.x/32,height:j.SMALL.y/32},{proba:10,size:j.MEDIUM_RECT,width:j.MEDIUM_RECT.x/32,height:j.MEDIUM_RECT.y/32},{proba:5,size:j.LARGE_RECT,width:j.LARGE_RECT.x/32,height:j.LARGE_RECT.y/32},{proba:5,size:j.LONG_RECT,width:j.LONG_RECT.x/32,height:j.LONG_RECT.y/32}]}return a.prototype.start=function(a,b){return this.running||this.waiting||(0!==o.level&&(p.sendBonus(4,5,this.map[4],this.bonusId),this.bonusId++),this.updateRate=b,this.current=0,this.levelHeight=a,this.running=!0,!l.debugMap)?void 0:this.debug()},a.prototype.reset=function(){return this.levelHeight=0,this.stop(),this.waiting=!1,this.bonusId=0,this.resetMap()},a.prototype.stop=function(){return this.running=!1},a.prototype.wait=function(){return this.stop(),this.waiting=!0,o.update(),this.fillMap()},a.prototype.resetMap=function(){var a,b,c,d;for(a=b=0;11>=b;a=++b)this.map[a]=0;for(d=[],a=c=0;11>=c;a=++c)d.push(this.cubeMap[a]=[]);return d},a.prototype.sendCube=function(){var a,b,c,d,e,f,g,h,i,j,k,m,n;if(b=this.checkCols(),b.length>0){if(g=this.randomizeType(b),h=g.type,i=g.index,d=b[i].length,f=Math.floor(Math.random()*d),a=b[i][f],void 0!==h.bonus)p.sendBonus(a.column,h.bonusId,this.bonusId),this.bonusId++;else if(void 0!==h.special)"explosion"===h.special&&this.explodeMap(a.column,a.height),p.sendSpecial(a.column,h.size,h.special);else for(p.sendCube(a.column,h.size),c=j=1,m=h.width;m>=1?m>=j:j>=m;c=m>=1?++j:--j)for(this.map[a.column+c-1]=a.height+h.height,e=k=0,n=h.height-1;n>=0?n>=k:k>=n;e=n>=0?++k:--k)this.cubeMap[a.column+c-1][a.height+e]=1;return l.debug&&p.sendMap(this.cubeMap),!0}return!1},a.prototype.randomizeType=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(e=[],t=this.types,k=l=0,p=t.length;p>l;k=++l)j=t[k],void 0!==a[k]&&a[k].length>0&&e.push({type:j,index:k,proba:j.proba});if(e.length!==this.types.length)for(i=this.types.length/e.length,m=0,q=e.length;q>m;m++)d=e[m],d.proba*=i;for(h=[],g=0,b=n=0,r=e.length;r>n;b=++n)d=e[b],g+=d.proba,h.push({index:b,percent:g});for(f=Math.floor(Math.random()*g)+1,o=0,s=h.length;s>o;o++)if(c=h[o],f<=c.percent)return e[c.index];return e[h.length-1]},a.prototype.update=function(a){return this.running&&(this.current+=a,this.current>=this.updateRate&&(this.current=0,!l.debugMap&&!this.sendCube()))?this.wait():void 0},a.prototype.checkCols=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(a=[],o=this.map,c=j=0,m=o.length;m>j;c=++j)for(b=o[c],p=this.types,i=k=0,n=p.length;n>k;i=++k){for(h=p[i],f=!0,e=0,d=l=1,q=h.width;q>=1?q>=l:l>=q;d=q>=1?++l:--l){if(g=this.map[c+d-1],!(g+h.height<=this.levelHeight)){f=!1;break}g>e&&(e=g)}f&&(void 0===a[i]&&(a[i]=[]),a[i].push({column:c,height:e}))}return a},a.prototype.explodeMap=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(e=l=-4;5>=l;e=++l)if(f=e>0?e-1:e,h=a+e,h>=0&&11>=h&&(d=-5+Math.abs(f),c=0,void 0!==this.cubeMap[h]&&null!==this.cubeMap[h]&&(c=this.cubeMap[h].length),i=b+d+1,j=b-d+1,void 0!==this.cubeMap[h]&&null!==this.cubeMap[h]))for(o=this.cubeMap[h],g=m=0,n=o.length;n>m;g=++m)k=o[g],g>i&&j>g&&(this.cubeMap[h][g]=null);return this.syncMap()},a.prototype.syncMap=function(){var a,b,c,d,e,f,g,h;for(g=this.cubeMap,h=[],a=e=0,f=g.length;f>e;a=++e)c=g[a],this.cubeMap[a]=this.cubeMap[a].filter(function(a){return a}),d=this.cubeMap[a].lastIndexOf(1),this.cubeMap[a]=-1===d?[]:this.cubeMap[a].slice(0,d+1),b=0,void 0!==this.cubeMap[a]&&null!==this.cubeMap[a]&&(b=this.cubeMap[a].length),h.push(this.map[a]=b);return h},a.prototype.fillMap=function(){var a,b,c;for(c=[],a=b=0;11>=b;a=++b)this.map[a]=0,c.push(this.cubeMap[a]=[]);return c},a.prototype.debug=function(){var a,b;return b=this,a=function(){var a,c;return a=0,c=0,p.sendCube(a,j.MEDIUM),b.cubeMap[a][c]=1,b.cubeMap[a+1][c]=1,b.cubeMap[a][c+1]=1,b.cubeMap[a+1][c+1]=1,p.sendMap(b.cubeMap)},setTimeout(a,200),a=function(){var a,c;return a=1,c=2,p.sendCube(a,j.MEDIUM),b.cubeMap[a][c]=1,b.cubeMap[a+1][c]=1,b.cubeMap[a][c+1]=1,b.cubeMap[a+1][c+1]=1,p.sendMap(b.cubeMap)},setTimeout(a,400),a=function(){var a,c;return a=0,c=4,p.sendCube(a,j.MEDIUM),b.cubeMap[a][c]=1,b.cubeMap[a+1][c]=1,b.cubeMap[a][c+1]=1,b.cubeMap[a+1][c+1]=1,p.sendMap(b.cubeMap)},setTimeout(a,600),a=function(){var a,c;return a=2,c=4,p.sendCube(a,j.MEDIUM),b.cubeMap[a][c]=1,b.cubeMap[a+1][c]=1,b.cubeMap[a][c+1]=1,b.cubeMap[a+1][c+1]=1,p.sendMap(b.cubeMap)},setTimeout(a,600),a=function(){var a,c;return a=5,c=0,p.sendSpecial(a,j.MEDIUM,"explosion"),b.explodeMap(a,c),p.sendMap(b.cubeMap)},setTimeout(a,3e3)},a}(),f=function(){function a(){this.level=0,this.speed=l.levelSpeed,this.tweens=[],this.lastHeight=0}return a.prototype.launch=function(){return this.nextLevel()},a.prototype.reset=function(){return p.sendResetLevel(),m.reset(),k.reset(),clearTimeout(p.timeout),this.level=0,this.speed=l.levelSpeed,this.bossRound=!1},a.prototype.moveStage=function(){var a;return a=32*this.lastHeight,p.moveLevel(a)},a.prototype.update=function(){return this.level++,this.speed-=l.speedPerLevel,this.moveStage()},a.prototype.randomizeHeight=function(){var a,b;return b=Math.round(4+this.level/2),a=Math.round(8+this.level/2),Math.floor(Math.random()*(a-b)+b)},a.prototype.nextLevel=function(){return m.running?void 0:(clearTimeout(p.timeout),this.clearLevel(),this.lastHeight=this.randomizeHeight(),m.start(this.lastHeight,this.speed))},a.prototype.clearLevel=function(){return p.sendClearLevel()},a.prototype.nextBoss=function(){return k.launched?void 0:(clearTimeout(p.timeout),k.launch())},a.prototype.passNextLevel=function(){return m.waiting=!1,k.launched=!1,o.nextLevel()},a}(),g=function(){function a(){this.io=require("socket.io").listen(8080),this.waitingFor=0,this.responseOk=0,this.listener()}return a.prototype.listener=function(){var a;return a=this,this.io.sockets.on("connection",function(b){var c,d,e,f;for(d=a.io.sockets.clients(),e=0,f=d.length;f>e;e++)c=d[e],c.id!==b.id&&(c.get("name",function(a,d){return c.get("skin",function(a,e){return b.emit("connection",[c.id,d,e])})}),c.get("position",function(a,d){return null!==d?b.emit("move",[c.id,d.x,d.y]):void 0}),c.get("animation",function(a,d){return null!==d?b.emit("changeAnimation",[c.id,d]):void 0}),c.get("animationSide",function(a,d){return null!==d?b.emit("changeAnimationSide",[c.id,d]):void 0}));return b.on("login",function(a){return b.set("name",a[0]),b.set("skin",a[1]),b.broadcast.emit("connection",[b.id,a[0],a[1]])}),b.on("launch",function(){return n.launch()}),b.on("reset",function(){return n.reset(),a.sendResetLevel()}),b.on("die",function(){return b.broadcast.emit("kill",b.id)}),b.on("move",function(a){return b.set("position",{x:parseInt(a[0]),y:parseInt(a[1])})}),b.on("changeAnimation",function(a){return b.set("animation",a)}),b.on("changeAnimationSide",function(a){return b.set("animationSide",a)}),b.on("moveLevelOk",function(){return a.responseOk++,a.responseOk>=a.waitingFor?o.nextBoss():void 0}),b.on("bonusTaken",function(a){return b.broadcast.emit("bonusTaken",a)}),b.on("bossBeaten",function(){return a.responseOk++,a.responseOk>=a.waitingFor?o.passNextLevel():void 0}),b.on("resurection",function(){return b.broadcast.emit("resurection")}),b.on("message",function(a){return b.broadcast.emit("message",[b.id,a])}),b.on("disconnect",function(){return b.broadcast.emit("disconnect",b.id)})})},a.prototype.sendCube=function(a,b){return this.io.sockets.emit("fallingCube",[a,b])},a.prototype.sendBonus=function(a,b,c){return this.io.sockets.emit("fallingBonus",[a,b,c])},a.prototype.sendSpecial=function(a,b,c){return this.io.sockets.emit("fallingSpecial",[a,b,c])},a.prototype.sendResetLevel=function(){return this.io.sockets.emit("resetLevel")},a.prototype.sendClearLevel=function(){return this.io.sockets.emit("clearLevel")},a.prototype.moveLevel=function(a){return this.waitForAll(o.nextBoss,l.timeout),this.io.sockets.emit("moveLevel",a)},a.prototype.sendBoss=function(a,b,c){return this.waitForAll(o.passNextLevel,l.timeout+c),this.sendClearLevel(),this.io.sockets.emit("spawnBoss",[a,b])},a.prototype.sendPositions=function(){var a,b,c,d,e,f;for(c=this,b=this.io.sockets.clients(),f=[],d=0,e=b.length;e>d;d++)a=b[d],f.push(a.get("cachedData",function(b,d){return a.get("position",function(b,e){return null===d&&(d={}),null!==e&&d.position!==e?(c.io.sockets.emit("move",[a.id,e.x,e.y]),d.position=e):void 0}),a.get("animation",function(b,e){return null!==e&&d.animation!==e?(c.io.sockets.emit("changeAnimation",[a.id,e]),d.animation=e):void 0}),a.get("animationSide",function(b,e){return null!==e&&d.animationSide!==e?(c.io.sockets.emit("changeAnimationSide",[a.id,e]),d.animationSide=e):void 0}),a.set("cachedData",d)}));return f},a.prototype.waitForAll=function(a,b){return this.waitingFor=this.io.sockets.clients().length,this.responseOk=0,this.timeout=setTimeout(a,b)},a.prototype.sendPlayerList=function(){var a,b,c,d,e;for(a=[],c=this.io.sockets.clients(),d=0,e=c.length;e>d;d++)b=c[d],a.push(b.id);return this.io.sockets.emit("playerList",a)},a.prototype.sendMap=function(a){return this.io.sockets.emit("debugMap",a)},a}(),a=function(){function a(a,b,c){this.timeout=b,this.name=a,this.options=c}return a}(),b=function(){function a(){this.launched=!1,this.boss=["roueman","freezeman","poingman"]}return a.prototype.launch=function(){var a;return a=this.getBoss(),p.sendBoss(a.id,a.options,a.timeout),this.launched=!0},a.prototype.reset=function(){return this.launched=!1},a.prototype.getBoss=function(){var a;return a=this.boss[Math.floor(Math.random()*this.boss.length)],"roueman"===a?new i:"freezeman"===a?new d:"poingman"===a?new h:void 0},a}(),i=function(a){function b(){b.__super__.constructor.call(this,"roueman",15e3,this.getPattern()),this.id=1}return s(b,a),b.prototype.getPattern=function(){var a,b,c,d,e,f;for(e=Math.round(100*(.6+.1*o.level))/100,c=e,a=[],b=f=0;5>=f;b=++f)d=Math.floor(100*Math.random()+1),a.push(d>=50?3:1);return[c,a]},b}(a),d=function(a){function b(){b.__super__.constructor.call(this,"freezeman",15e3,this.getPattern()),this.id=2}return s(b,a),b.prototype.getPattern=function(){var a,b,c,d,e,f,g;for(f=Math.round(100*(.4+.1*o.level))/100,d=1500-50*o.level,e=[f,d],b=[],c=g=0;5>=g;c=++g)a=Math.floor(10*Math.random()+1),b.push([4+a,4+a-20]);return[e,b]},b}(a),h=function(a){function b(){b.__super__.constructor.call(this,"poingman",15e3,this.getPattern()),this.id=3}return s(b,a),b.prototype.getPattern=function(){var a,b,c,d,e,f,g,h;for(f=Math.round(100*(.4+.05*o.level))/100,b=Math.round(100*(.6+.05*o.level))/100,g=500-30*o.level,e=[f,b,g],c=[],d=h=0;5>=h;d=++h)a=Math.floor(10*Math.random()),c.push(a);return[e,c]},b}(a),p=new g,n=new e,m=new c,o=new f,k=new b,setInterval(function(){return n.loop()},1e3/l.FPS),setInterval(function(){return q()},1e3/l.lowFPS),n.update=function(a){return m.update(a),p.sendPositions()},q=function(){return p.sendPlayerList()}}).call(this);